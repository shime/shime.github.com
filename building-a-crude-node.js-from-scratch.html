<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="//gmpg.org/xfn/11" rel="profile">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/monokai.css?1593546354567484000">
  <link rel="stylesheet" href="/public/css/style.css?1593546354567484000">

  <link rel="icon" sizes="16x16 32x32 64x64" href="/public/favicon.ico">
<link rel="icon" type="image/png" sizes="196x196" href="/public/favicon-196.png">
<link rel="icon" type="image/png" sizes="160x160" href="/public/favicon-160.png">
<link rel="icon" type="image/png" sizes="128x128" href="/public/favicon-128.png">
<link rel="icon" type="image/png" sizes="96x96" href="/public/favicon-96.png">
<link rel="icon" type="image/png" sizes="64x64" href="/public/favicon-64.png">
<link rel="icon" type="image/png" sizes="32x32" href="/public/favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/public/favicon-16.png">
<link rel="apple-touch-icon" href="/public/favicon-57.png">
<link rel="apple-touch-icon" sizes="180x180" href="/public/favicon-180.png">
<link rel="apple-touch-icon" sizes="152x152" href="/public/favicon-152.png">
<link rel="apple-touch-icon" sizes="144x144" href="/public/favicon-144.png">
<link rel="apple-touch-icon" sizes="120x120" href="/public/favicon-120.png">
<link rel="apple-touch-icon" sizes="114x114" href="/public/favicon-114.png">
<link rel="apple-touch-icon" sizes="76x76" href="/public/favicon-76.png">
<link rel="apple-touch-icon" sizes="72x72" href="/public/favicon-72.png">
<link rel="apple-touch-icon" sizes="60x60" href="/public/favicon-60.png">
<meta name="msapplication-TileColor" content="#FFFFFF">
<meta name="msapplication-TileImage" content="/public/favicon-144.png">
<meta name="msapplication-config" content="/public/browserconfig.xml">


  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v3.8.7" />
<meta property="og:title" content="Building a crude Node.js from scratch" />
<meta name="author" content="Hrvoje ≈†imiƒá" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Node is powered by the JavaScript engine used in Google Chrome, called V8[1]. In this post I&#39;m going to guide you through two steps:" />
<meta property="og:description" content="Node is powered by the JavaScript engine used in Google Chrome, called V8[1]. In this post I&#39;m going to guide you through two steps:" />
<link rel="canonical" href="http://shime.sh/building-a-crude-node.js-from-scratch" />
<meta property="og:url" content="http://shime.sh/building-a-crude-node.js-from-scratch" />
<meta property="og:site_name" content="Hrvoje ≈†imiƒá" />
<meta property="og:image" content="http://shime.sh/public/social.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-10-10T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:image" content="http://shime.sh/public/social.jpg" />
<meta property="twitter:title" content="Building a crude Node.js from scratch" />
<meta name="twitter:site" content="@shime_sh" />
<meta name="twitter:creator" content="@shime_sh" />
<script type="application/ld+json">
{"headline":"Building a crude Node.js from scratch","dateModified":"2017-10-10T00:00:00+02:00","url":"http://shime.sh/building-a-crude-node.js-from-scratch","datePublished":"2017-10-10T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://shime.sh/building-a-crude-node.js-from-scratch"},"author":{"@type":"Person","name":"Hrvoje ≈†imiƒá"},"description":"Node is powered by the JavaScript engine used in Google Chrome, called V8[1]. In this post I&#39;m going to guide you through two steps:","@type":"BlogPosting","image":"http://shime.sh/public/social.jpg","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  
    <title> Building a crude Node.js from scratch &middot; Hrvoje ≈†imiƒá </title>
  

  <meta name="title" content="Building a crude Node.js from scratch &middot; Hrvoje ≈†imiƒá">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.0/anchor.min.js"></script>

  
</head>


  <body class="font-sans">
    <div class="lg:pt-16 lg:pb-32 p-6 relative">
      




<div class="relative flex justify-between items-start w-full z-20 md:justify-center self-center">
  <div class="flex items-center">
    <a class="self-start w-16 h-16" href="/">
      <img class="self-start rounded-full w-16 h-16" src='/public/shime.jpg' alt='' />
    </a>

    <div class="flex flex-col ml-4">
      <a class="text-black font-bold text-xl no-underline font-extrabold self-start" href="/">Hrvoje ≈†imiƒá</a>
      <a class="text-black font-bold no-underline font-extrabold my-1 self-start" href="https://twitter.com/shime_sh">@shime_sh</a>
      <ul class="hidden md:block list-reset tracking-wide">
        
        <li class="inline">
          
            <a class="font-medium text-xs text-grey no-underline uppercase mr-2 hover:text-blue-light" href='/articles/'>Articles</a>
          
        </li>
        
        <li class="inline">
          
            <a class="font-medium text-xs text-grey no-underline uppercase mr-2 hover:text-blue-light" href='/til/'>TIL</a>
          
        </li>
        
        <li class="inline">
          
            <a class="font-medium text-xs text-grey no-underline uppercase mr-2 hover:text-blue-light" href='/photography/'>Photography</a>
          
        </li>
        
        <li class="inline">
          
            <a class="font-medium text-xs text-grey no-underline uppercase mr-2 hover:text-blue-light" href='/reading/'>Reading list</a>
          
        </li>
        
        <li class="inline">
          
            <a class="font-medium text-xs text-grey no-underline uppercase mr-2 hover:text-blue-light" href='/subscribe'>Subscribe</a>
          
        </li>
        
      </ul>
    </div>
  </div>

  <div class="block md:hidden self-center">
    <button data-open-hamburger-menu="true">
      <svg height="32" width="32" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path fill="black" class="heroicon-ui" d="M4 5h16a1 1 0 0 1 0 2H4a1 1 0 1 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2z"/>
      </svg>
    </button>

    <button data-close-hamburger-menu="true" class="hidden">
      <svg fill="black" height="32" id="close" viewBox="0 0 32 32" width="32" xmlns="http://www.w3.org/2000/svg">
        <path d="M4 8 L8 4 L16 12 L24 4 L28 8 L20 16 L28 24 L24 28 L16 20 L8 28 L4 24 L12 16 z"/>
      </svg>
    </button>
  </div>
</div>

<div class="hidden md:hidden fixed pin bg-white z-10 mt-32 pt-12" data-hamburger-menu="true">
  <ul class="list-reset tracking-wide flex flex-col items-center w-full">
    

    <li class="my-2">
      
        <a class="font-semibold text-xl text-black no-underline uppercase" href='/articles/'>Articles</a>
      
    </li>
    

    <li class="my-2">
      
        <a class="font-semibold text-xl text-black no-underline uppercase" href='/til/'>TIL</a>
      
    </li>
    

    <li class="my-2">
      
        <a class="font-semibold text-xl text-black no-underline uppercase" href='/photography/'>Photography</a>
      
    </li>
    

    <li class="my-2">
      
        <a class="font-semibold text-xl text-black no-underline uppercase" href='/reading/'>Reading list</a>
      
    </li>
    

    <li class="my-2">
      
        <a class="font-semibold text-xl text-black no-underline uppercase" href='/subscribe'>Subscribe</a>
      
    </li>
    
  </ul>
</div>


      <div class="w-full flex justify-center text-lg mt-16 text-grey-darker font-light leading-normal">
        <div class="flex-col">
          <div class="max-w-full">
            

          </div>

          <div class="post max-w-full md:max-w-md">
            
            

            
            <div>
              <a class="no-underline uppercase text-sm" href="/articles"> ‚Üê articles </a>
            </div>
            
            <div class="mb-8">
              <h1>Building a crude Node.js from scratch</h1>
              
              <div class="text-grey">
                October 10, 2017
              </div>
              

              <div class="flex my-2">
                
                  <span class="bg-blue-lightest py-1 px-2 text-center text-blue-dark mr-2 rounded text-sm">
                    javascript
                  </span>
                
              </div>
            </div>

            <p>Node is powered by the JavaScript engine used in Google Chrome, called V8<sup>[<a href="#v8">1</a>]</sup>. In this post I&#39;m going to guide you through two steps:</p>

<ul>
<li>making a &quot;Hello World&quot; example in V8</li>
<li>making a crude Node runtime with support for 3 statements: <code>console.log</code>, <code>console.error</code> and <code>quit</code> for quitting the process</li>
</ul>

<p>In our new crude runtime we&#39;ll execute the following script:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;üéâ&quot;</span><span class="p">);</span>
<span class="nx">b</span><span class="o">=</span><span class="mi">4</span><span class="o">+</span><span class="mi">4</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
<span class="nx">quit</span><span class="p">();</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;never reach this&quot;</span><span class="p">);</span>
</code></pre></div>
<hr>

<h2>Setting up the hello world example</h2>

<p>First things first. Let&#39;s execute a JavaScript string concatenation in V8! We&#39;ll write an example that takes a JavaScript statement as a string argument, executes it as JavaScript code, and prints the result to standard out. The string will be
<code>js
&#39;Hello&#39; + &#39;, World!&#39;
</code></p>

<p>The setup will loosely follow <a href="https://gist.github.com/netpoetica/28ce31478cfc43edcaa7">this gist</a> in combination with the <a href="https://github.com/v8/v8/wiki/Getting-Started-with-Embedding">V8 getting started with embedding wiki</a>.</p>

<p>We&#39;re going to use version 5.8 of V8. I&#39;m going to assume you&#39;re using MacOS with git, Python 2.7 and Xcode installed and that you&#39;re using Bash as your shell of choice.</p>

<h3>Clone the v8 source</h3>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>git clone https://github.com/v8/v8.git
</code></pre></div>
<hr>

<h3>Install depot tools and add it to our path</h3>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
<span class="nb">cd</span> depot_tools
<span class="nb">echo</span> <span class="s2">&quot;export PATH=`pwd`:\&quot;</span><span class="nv">$PATH</span><span class="s2">\&quot;&quot;</span> &gt;&gt; ~/.bashrc <span class="c1"># replace with ~/.zshrc if using ZSH</span>
<span class="nb">source</span> ~/.bashrc <span class="c1"># or ~/.zshrc</span>
<span class="nb">cd</span> -
</code></pre></div>
<hr>

<h3>Make sure you have clang and clang++ installed</h3>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>which clang <span class="o">&amp;&amp;</span> which clang++ <span class="c1"># should output paths to clangs</span>
</code></pre></div>
<p>If you don&#39;t have clang and clang++ make sure you have installed Xcode.</p>

<hr>

<h3>Add environment libraries for clang and clang++</h3>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>cat <span class="s">&lt;&lt;EOT &gt;&gt; ~/.bashrc # replace with ~/.zshrc if using ZSH</span>
<span class="s">export CXX=&quot;`which clang++`&quot;</span>
<span class="s">export CC=&quot;`which clang`&quot;</span>
<span class="s">export CPP=&quot;`which clang` -E&quot;</span>
<span class="s">export LINK=&quot;`which clang++`&quot;</span>
<span class="s">export CXX_host=&quot;`which clang++`&quot;</span>
<span class="s">export CC_host=&quot;`which clang`&quot;</span>
<span class="s">export CPP_host=&quot;`which clang` -E&quot;</span>
<span class="s">export LINK_host=&quot;`which clang++`&quot;</span>
<span class="s">export GYP_DEFINES=&quot;clang=1&quot;</span>
<span class="s">EOT</span>

<span class="nb">source</span> ~/.bashrc <span class="c1"># or ~/.zshrc</span>
</code></pre></div>
<hr>

<h3>Update .git/config of V8 to fetch remotes and tags</h3>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span><span class="nb">cd</span> v8
vim .git/config
</code></pre></div>
<p>Update config for remote origin to this</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>[remote &quot;origin&quot;]
  url = https://chromium.googlesource.com/v8/v8.git
  fetch = +refs/branch-heads/*:refs/remotes/branch-heads/*
  fetch = +refs/tags/*:refs/tags/*
</code></pre></div>
<p>Exit vim<sup>[<a href="#wq">2</a>]</sup> and fetch origin.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>git fetch
</code></pre></div>
<hr>

<h3>Checkout to a new branch for version 5.8 of V8</h3>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>git checkout -b <span class="m">5</span>.8 -t branch-heads/5.8
</code></pre></div>
<hr>

<h3>Sync this git repo</h3>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>gclient sync
</code></pre></div>
<hr>

<h3>Create build configuration</h3>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>tools/dev/v8gen.py x64.release
</code></pre></div>
<hr>

<h3>Edit the default build configuration</h3>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>gn args out.gn/x64.release
</code></pre></div>
<p>And add these two lines to that configuration:</p>
<div class="highlight"><pre><code class="language-makefile" data-lang="makefile"><span></span><span class="nv">is_component_build</span> <span class="o">=</span> <span class="nb">false</span>
<span class="nv">v8_static_library</span> <span class="o">=</span> <span class="nb">true</span>
</code></pre></div>
<hr>

<h3>Build v8</h3>

<p>You&#39;ll have to detect a number of cores your CPU has. Go to Activity Monitor and click on <em>CPU LOAD</em> section. Window with graphs should pop up - the number of cores is the number of panels on that window.</p>

<p>For my 2015 i7 CPU it&#39;s 4, so I&#39;m running the following command:
<code>bash
make native -j 4
</code>
If you&#39;re not sure just run it without <code>-j</code> flag</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>make native
</code></pre></div>
<p>Alternatively you can just use Ninja like this:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>ninja -C out.gn/x64.release
</code></pre></div>
<hr>

<h3>Add hello world</h3>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>vim hello_world.cpp
</code></pre></div>
<p>Save this in <code>hello_world.cpp</code><sup>[<a href="#hello-world">3</a>]</sup>:</p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span></span><span class="c1">// Copyright 2015 the V8 project authors. All rights reserved.</span>
<span class="c1">// Use of this source code is governed by a BSD-style license that can be</span>
<span class="c1">// found in the LICENSE file.</span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;include/libplatform/libplatform.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;include/v8.h&quot;</span><span class="cp"></span>
<span class="n">using</span> <span class="n">namespace</span> <span class="n">v8</span><span class="p">;</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="c1">// Initialize V8.</span>
  <span class="n">V8</span><span class="o">::</span><span class="n">InitializeICUDefaultLocation</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="n">V8</span><span class="o">::</span><span class="n">InitializeExternalStartupData</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="n">Platform</span><span class="o">*</span> <span class="n">platform</span> <span class="o">=</span> <span class="n">platform</span><span class="o">::</span><span class="n">CreateDefaultPlatform</span><span class="p">();</span>
  <span class="n">V8</span><span class="o">::</span><span class="n">InitializePlatform</span><span class="p">(</span><span class="n">platform</span><span class="p">);</span>
  <span class="n">V8</span><span class="o">::</span><span class="n">Initialize</span><span class="p">();</span>
  <span class="c1">// Create a new Isolate and make it the current one.</span>
  <span class="n">Isolate</span><span class="o">::</span><span class="n">CreateParams</span> <span class="n">create_params</span><span class="p">;</span>
  <span class="n">create_params</span><span class="p">.</span><span class="n">array_buffer_allocator</span> <span class="o">=</span>
      <span class="n">v8</span><span class="o">::</span><span class="n">ArrayBuffer</span><span class="o">::</span><span class="n">Allocator</span><span class="o">::</span><span class="n">NewDefaultAllocator</span><span class="p">();</span>
  <span class="n">Isolate</span><span class="o">*</span> <span class="n">isolate</span> <span class="o">=</span> <span class="n">Isolate</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">create_params</span><span class="p">);</span>
  <span class="p">{</span>
    <span class="n">Isolate</span><span class="o">::</span><span class="n">Scope</span> <span class="n">isolate_scope</span><span class="p">(</span><span class="n">isolate</span><span class="p">);</span>
    <span class="c1">// Create a stack-allocated handle scope.</span>
    <span class="n">HandleScope</span> <span class="n">handle_scope</span><span class="p">(</span><span class="n">isolate</span><span class="p">);</span>
    <span class="c1">// Create a new context.</span>
    <span class="n">Local</span><span class="o">&lt;</span><span class="n">Context</span><span class="o">&gt;</span> <span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">);</span>
    <span class="c1">// Enter the context for compiling and running the hello world script.</span>
    <span class="n">Context</span><span class="o">::</span><span class="n">Scope</span> <span class="n">context_scope</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
    <span class="c1">// Create a string containing the JavaScript source code.</span>
    <span class="n">Local</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">source</span> <span class="o">=</span>
        <span class="n">String</span><span class="o">::</span><span class="n">NewFromUtf8</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span> <span class="s">&quot;&#39;Hello&#39; + &#39;, World!&#39;&quot;</span><span class="p">,</span>
                            <span class="n">NewStringType</span><span class="o">::</span><span class="n">kNormal</span><span class="p">).</span><span class="n">ToLocalChecked</span><span class="p">();</span>
    <span class="c1">// Compile the source code.</span>
    <span class="n">Local</span><span class="o">&lt;</span><span class="n">Script</span><span class="o">&gt;</span> <span class="n">script</span> <span class="o">=</span> <span class="n">Script</span><span class="o">::</span><span class="n">Compile</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">source</span><span class="p">).</span><span class="n">ToLocalChecked</span><span class="p">();</span>
    <span class="c1">// Run the script to get the result.</span>
    <span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">script</span><span class="o">-&gt;</span><span class="n">Run</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="n">ToLocalChecked</span><span class="p">();</span>
    <span class="c1">// Convert the result to an UTF8 string and print it.</span>
    <span class="n">String</span><span class="o">::</span><span class="n">Utf8Value</span> <span class="n">utf8</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">utf8</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// Dispose the isolate and tear down V8.</span>
  <span class="n">isolate</span><span class="o">-&gt;</span><span class="n">Dispose</span><span class="p">();</span>
  <span class="n">V8</span><span class="o">::</span><span class="n">Dispose</span><span class="p">();</span>
  <span class="n">V8</span><span class="o">::</span><span class="n">ShutdownPlatform</span><span class="p">();</span>
  <span class="n">delete</span> <span class="n">platform</span><span class="p">;</span>
  <span class="n">delete</span> <span class="n">create_params</span><span class="p">.</span><span class="n">array_buffer_allocator</span><span class="p">;</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<hr>

<h3>Copy snapshots</h3>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>cp out.gn/x64.release/*.bin .
</code></pre></div>
<hr>

<h3>Compile the hello world example</h3>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>clang++ -Iinclude out/native/*.a hello_world.cpp -o hello_world
</code></pre></div>
<hr>

<h3>Run the hello world example</h3>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>./hello_world
</code></pre></div>
<p>You should see</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>Hello, World!
</code></pre></div>
<p>in your shell. Now that we have a hello world example up and running, we can start adding support for <code>console.log</code>, <code>console.error</code> and <code>quit</code>.</p>

<h2>Add support for console and quit statements</h2>

<p>Add the following to <code>run_script.cpp</code><sup>[<a href="#example">4</a>]</sup>:</p>
<div class="highlight"><pre><code class="language-c" data-lang="c"><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;fstream&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sstream&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;include/libplatform/libplatform.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;include/v8.h&quot;</span><span class="cp"></span>

<span class="n">using</span> <span class="n">namespace</span> <span class="n">v8</span><span class="p">;</span>

<span class="c1">// Define a quit function that exits.</span>
<span class="kt">void</span> <span class="nf">quit</span><span class="p">(</span><span class="k">const</span> <span class="n">v8</span><span class="o">::</span><span class="n">FunctionCallbackInfo</span><span class="o">&lt;</span><span class="n">v8</span><span class="o">::</span><span class="n">Value</span><span class="o">&gt;&amp;</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Store isolate in a global variable.</span>
<span class="n">Isolate</span><span class="o">*</span> <span class="n">isolate_</span><span class="p">;</span>
<span class="n">Isolate</span><span class="o">*</span> <span class="nf">GetIsolate</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">isolate_</span><span class="p">;</span> <span class="p">}</span>

<span class="c1">// Define a Console class.</span>
<span class="n">class</span> <span class="n">Console</span> <span class="p">{</span> <span class="p">};</span>

<span class="c1">// Extracts a C string from a V8 Utf8Value.</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">ToCString</span><span class="p">(</span><span class="k">const</span> <span class="n">v8</span><span class="o">::</span><span class="n">String</span><span class="o">::</span><span class="n">Utf8Value</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">*</span><span class="n">value</span> <span class="o">?</span> <span class="o">*</span><span class="nl">value</span> <span class="p">:</span> <span class="s">&quot;&lt;string conversion failed&gt;&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Define a log function that prints to stdout.</span>
<span class="kt">void</span> <span class="nf">log</span><span class="p">(</span><span class="k">const</span> <span class="n">FunctionCallbackInfo</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;&amp;</span> <span class="n">args</span><span class="p">){</span>
  <span class="n">v8</span><span class="o">::</span><span class="n">String</span><span class="o">::</span><span class="n">Utf8Value</span> <span class="n">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">cstr</span> <span class="o">=</span> <span class="n">ToCString</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cstr</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Define an error function that prints to stderr.</span>
<span class="kt">void</span> <span class="nf">error</span><span class="p">(</span><span class="k">const</span> <span class="n">FunctionCallbackInfo</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;&amp;</span> <span class="n">args</span><span class="p">){</span>
  <span class="n">v8</span><span class="o">::</span><span class="n">String</span><span class="o">::</span><span class="n">Utf8Value</span> <span class="n">str</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">cstr</span> <span class="o">=</span> <span class="n">ToCString</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
  <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cstr</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">Local</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">WrapConsoleObject</span><span class="p">(</span><span class="n">Console</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">EscapableHandleScope</span> <span class="n">handle_scope</span><span class="p">(</span><span class="n">GetIsolate</span><span class="p">());</span>

  <span class="n">Local</span><span class="o">&lt;</span><span class="n">ObjectTemplate</span><span class="o">&gt;</span> <span class="n">class_t</span><span class="p">;</span>
  <span class="n">Local</span><span class="o">&lt;</span><span class="n">ObjectTemplate</span><span class="o">&gt;</span> <span class="n">raw_t</span> <span class="o">=</span> <span class="n">ObjectTemplate</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">GetIsolate</span><span class="p">());</span>
  <span class="n">raw_t</span><span class="o">-&gt;</span><span class="n">SetInternalFieldCount</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

  <span class="c1">// Set log method.</span>
  <span class="n">raw_t</span><span class="o">-&gt;</span><span class="n">Set</span><span class="p">(</span>
      <span class="n">v8</span><span class="o">::</span><span class="n">String</span><span class="o">::</span><span class="n">NewFromUtf8</span><span class="p">(</span><span class="n">GetIsolate</span><span class="p">(),</span> <span class="s">&quot;log&quot;</span><span class="p">,</span> <span class="n">v8</span><span class="o">::</span><span class="n">NewStringType</span><span class="o">::</span><span class="n">kNormal</span><span class="p">).</span><span class="n">ToLocalChecked</span><span class="p">(),</span>
      <span class="n">v8</span><span class="o">::</span><span class="n">FunctionTemplate</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">GetIsolate</span><span class="p">(),</span> <span class="n">log</span><span class="p">));</span>

  <span class="c1">// Set error method.</span>
  <span class="n">raw_t</span><span class="o">-&gt;</span><span class="n">Set</span><span class="p">(</span>
      <span class="n">v8</span><span class="o">::</span><span class="n">String</span><span class="o">::</span><span class="n">NewFromUtf8</span><span class="p">(</span><span class="n">GetIsolate</span><span class="p">(),</span> <span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="n">v8</span><span class="o">::</span><span class="n">NewStringType</span><span class="o">::</span><span class="n">kNormal</span><span class="p">).</span><span class="n">ToLocalChecked</span><span class="p">(),</span>
      <span class="n">v8</span><span class="o">::</span><span class="n">FunctionTemplate</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">GetIsolate</span><span class="p">(),</span> <span class="n">error</span><span class="p">));</span>
  <span class="n">class_t</span> <span class="o">=</span> <span class="n">Local</span><span class="o">&lt;</span><span class="n">ObjectTemplate</span><span class="o">&gt;::</span><span class="n">New</span><span class="p">(</span><span class="n">GetIsolate</span><span class="p">(),</span><span class="n">raw_t</span><span class="p">);</span>

  <span class="c1">// Create instance.</span>
  <span class="n">Local</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">class_t</span><span class="o">-&gt;</span><span class="n">NewInstance</span><span class="p">(</span><span class="n">GetIsolate</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetCurrentContext</span><span class="p">()).</span><span class="n">ToLocalChecked</span><span class="p">();</span>

  <span class="c1">// Create wrapper.</span>
  <span class="n">Local</span><span class="o">&lt;</span><span class="n">External</span><span class="o">&gt;</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">External</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">GetIsolate</span><span class="p">(),</span><span class="n">c</span><span class="p">);</span>
  <span class="n">result</span><span class="o">-&gt;</span><span class="n">SetInternalField</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ptr</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">handle_scope</span><span class="p">.</span><span class="n">Escape</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="c1">// Initialize V8.</span>
  <span class="n">V8</span><span class="o">::</span><span class="n">InitializeICUDefaultLocation</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="n">V8</span><span class="o">::</span><span class="n">InitializeExternalStartupData</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="n">Platform</span><span class="o">*</span> <span class="n">platform</span> <span class="o">=</span> <span class="n">platform</span><span class="o">::</span><span class="n">CreateDefaultPlatform</span><span class="p">();</span>
  <span class="n">V8</span><span class="o">::</span><span class="n">InitializePlatform</span><span class="p">(</span><span class="n">platform</span><span class="p">);</span>
  <span class="n">V8</span><span class="o">::</span><span class="n">Initialize</span><span class="p">();</span>

  <span class="c1">// Get JavaScript script file from the first argument.</span>
  <span class="kt">FILE</span><span class="o">*</span> <span class="n">file</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&quot;r&quot;</span><span class="p">);</span>
  <span class="n">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_END</span><span class="p">);</span>
  <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">ftell</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
  <span class="n">rewind</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
  <span class="kt">char</span><span class="o">*</span> <span class="n">fileScript</span> <span class="o">=</span> <span class="n">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
  <span class="n">fileScript</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;)</span> <span class="p">{</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="n">fread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fileScript</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

  <span class="c1">// Create a new Isolate and make it the current one.</span>
  <span class="n">Isolate</span><span class="o">::</span><span class="n">CreateParams</span> <span class="n">create_params</span><span class="p">;</span>
  <span class="n">create_params</span><span class="p">.</span><span class="n">array_buffer_allocator</span> <span class="o">=</span>
    <span class="n">v8</span><span class="o">::</span><span class="n">ArrayBuffer</span><span class="o">::</span><span class="n">Allocator</span><span class="o">::</span><span class="n">NewDefaultAllocator</span><span class="p">();</span>
  <span class="n">Isolate</span><span class="o">*</span> <span class="n">isolate</span> <span class="o">=</span> <span class="n">Isolate</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">create_params</span><span class="p">);</span>
  <span class="p">{</span>
    <span class="n">Isolate</span><span class="o">::</span><span class="n">Scope</span> <span class="n">isolate_scope</span><span class="p">(</span><span class="n">isolate</span><span class="p">);</span>
    <span class="n">isolate_</span> <span class="o">=</span> <span class="n">isolate</span><span class="p">;</span>

    <span class="c1">// Create a stack-allocated handle scope.</span>
    <span class="n">HandleScope</span> <span class="nf">handle_scope</span><span class="p">(</span><span class="n">isolate</span><span class="p">);</span>

    <span class="c1">// Create a template.</span>
    <span class="n">v8</span><span class="o">::</span><span class="n">Local</span><span class="o">&lt;</span><span class="n">v8</span><span class="o">::</span><span class="n">ObjectTemplate</span><span class="o">&gt;</span> <span class="n">global</span> <span class="o">=</span> <span class="n">v8</span><span class="o">::</span><span class="n">ObjectTemplate</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">);</span>

    <span class="c1">// Set a quit statement to global context.</span>
    <span class="n">global</span><span class="o">-&gt;</span><span class="n">Set</span><span class="p">(</span>
        <span class="n">v8</span><span class="o">::</span><span class="n">String</span><span class="o">::</span><span class="n">NewFromUtf8</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span> <span class="s">&quot;quit&quot;</span><span class="p">,</span> <span class="n">v8</span><span class="o">::</span><span class="n">NewStringType</span><span class="o">::</span><span class="n">kNormal</span><span class="p">)</span>
        <span class="p">.</span><span class="n">ToLocalChecked</span><span class="p">(),</span>
        <span class="n">v8</span><span class="o">::</span><span class="n">FunctionTemplate</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span> <span class="n">quit</span><span class="p">));</span>

    <span class="c1">// Create a new context.</span>
    <span class="n">Local</span><span class="o">&lt;</span><span class="n">Context</span><span class="o">&gt;</span> <span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="o">::</span><span class="n">New</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">global</span><span class="p">);</span>

    <span class="c1">// Enter the context for compiling and running the hello world script.</span>
    <span class="n">Context</span><span class="o">::</span><span class="n">Scope</span> <span class="n">context_scope</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>

    <span class="c1">// Create a JavaScript console object.</span>
    <span class="n">Console</span><span class="o">*</span> <span class="n">c</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Console</span><span class="p">();</span>
    <span class="n">Local</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">con</span> <span class="o">=</span> <span class="n">WrapConsoleObject</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="c1">// Set a console statement to global context.</span>
    <span class="n">context</span><span class="o">-&gt;</span><span class="n">Global</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Set</span><span class="p">(</span><span class="n">String</span><span class="o">::</span><span class="n">NewFromUtf8</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span> <span class="s">&quot;console&quot;</span><span class="p">,</span> <span class="n">NewStringType</span><span class="o">::</span><span class="n">kNormal</span><span class="p">).</span><span class="n">ToLocalChecked</span><span class="p">(),</span>
        <span class="n">con</span><span class="p">);</span>

    <span class="c1">// Create a string containing the JavaScript source code.</span>
    <span class="n">Local</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">source</span> <span class="o">=</span>
      <span class="n">String</span><span class="o">::</span><span class="n">NewFromUtf8</span><span class="p">(</span><span class="n">isolate</span><span class="p">,</span> <span class="n">fileScript</span><span class="p">,</span>
          <span class="n">NewStringType</span><span class="o">::</span><span class="n">kNormal</span><span class="p">).</span><span class="n">ToLocalChecked</span><span class="p">();</span>

    <span class="c1">// Compile the source code.</span>
    <span class="n">Local</span><span class="o">&lt;</span><span class="n">Script</span><span class="o">&gt;</span> <span class="n">script</span> <span class="o">=</span> <span class="n">Script</span><span class="o">::</span><span class="n">Compile</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">source</span><span class="p">).</span><span class="n">ToLocalChecked</span><span class="p">();</span>

    <span class="c1">// Run the script to get the result.</span>
    <span class="n">Local</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">script</span><span class="o">-&gt;</span><span class="n">Run</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="n">ToLocalChecked</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="c1">// Dispose the isolate and tear down V8.</span>
  <span class="n">isolate</span><span class="o">-&gt;</span><span class="n">Dispose</span><span class="p">();</span>
  <span class="n">V8</span><span class="o">::</span><span class="n">Dispose</span><span class="p">();</span>
  <span class="n">V8</span><span class="o">::</span><span class="n">ShutdownPlatform</span><span class="p">();</span>
  <span class="n">delete</span> <span class="n">platform</span><span class="p">;</span>
  <span class="n">delete</span> <span class="n">create_params</span><span class="p">.</span><span class="n">array_buffer_allocator</span><span class="p">;</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>After that, set up a JavaScript script at <code>test.js</code>:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;üéâ&quot;</span><span class="p">);</span>
<span class="nx">b</span><span class="o">=</span><span class="mi">4</span><span class="o">+</span><span class="mi">4</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
<span class="nx">quit</span><span class="p">();</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;never reach this&quot;</span><span class="p">);</span>
</code></pre></div>
<p>Compile our new program with</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>clang++ -Iinclude out/native/*.a run_script.cpp -o run_script
</code></pre></div>
<p>And run it with</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>./run_script test.js
</code></pre></div>
<p>You should see the following output</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>üéâ
<span class="m">8</span>
</code></pre></div>
<p>Phew! That&#39;s it - congratulate yourself for building a crude version of Node that only supports <code>console.log</code>, <code>console.error</code> and <code>quit</code> statements.</p>

<p>Having a global function <code>quit</code> like this is a little weird, so implementing a more normal <code>process.exit</code> is left as an exercise for the reader.</p>

<hr>

<p>If this article sparked your interest about Node internals, I strongly suggest you continue reading article named <em><a href="https://blog.ghaiklor.com/how-nodejs-works-bfe09efc80ca">How does NodeJS work</a></em>, which explains the concepts used in this article in greater detail.</p>

<hr>

<ol>
<li><a name="v8"></a>
More info about V8 can be found at their <a href="https://github.com/v8/v8/wiki">wiki</a>.</li>
<li><a name="wq"></a>
<strong>:wq</strong> or try searching <a href="https://stackoverflow.blog/2017/05/23/stack-overflow-helping-one-million-developers-exit-vim/">Stack Overflow</a>.</li>
<li><a name="hello-world"></a> Taken from V8 repo <a href="https://chromium.googlesource.com/v8/v8/+/branch-heads/5.8/samples/hello-world.cc">here</a>.</li>
<li><a name="example"></a>
This example is based on <a href="https://gist.github.com/tejom/d335a6ab1ac86b45f149e5c10e14b132">this gist</a>.</li>
</ol>


            <hr />

            
            
          </div>
        </div>
      </div>
    </div>
  </body>

  <script>
  var menu = document.querySelectorAll('[data-hamburger-menu]')[0]
  var openMenu = document.querySelectorAll('[data-open-hamburger-menu]')[0]
  var closeMenu = document.querySelectorAll('[data-close-hamburger-menu]')[0]
  var body = document.body

  openMenu.onclick = toggleMenu.bind(this, true);
  closeMenu.onclick = toggleMenu.bind(this, false);

  function toggleMenu(show) {
    toggleElements([openMenu], !show);
    toggleElements([menu, closeMenu], show);
    toggleScrolling(body, show);
  }

  function toggleElements(elements, show) {
    elements.forEach(function(element) {
      if (show) {
        element.classList.remove("hidden")
        element.classList.add("block");
      } else {
        element.classList.remove("block")
        element.classList.add("hidden");
      }
    })
  }

  function toggleScrolling(element, scrollDisabled) {
    var classes = ["scrolling-auto", "overflow-hidden", "fixed", "pin-x"];
    if (scrollDisabled) {
      classes.forEach(function(klass){
        element.classList.add(klass);
      })
    } else {
      classes.forEach(function(klass){
        element.classList.remove(klass);
      })
    }
  }

  var anchors = new AnchorJS();
  anchors.options = {
    placement: 'left'
  }
  anchors.add()
</script>

</html>
