<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="//gmpg.org/xfn/11" rel="profile">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/monokai.css?1607892219274190000">
  <link rel="stylesheet" href="/public/css/style.css?1607892219274190000">

  <link rel="icon" sizes="16x16 32x32 64x64" href="/public/favicon.ico">
<link rel="icon" type="image/png" sizes="196x196" href="/public/favicon-196.png">
<link rel="icon" type="image/png" sizes="160x160" href="/public/favicon-160.png">
<link rel="icon" type="image/png" sizes="128x128" href="/public/favicon-128.png">
<link rel="icon" type="image/png" sizes="96x96" href="/public/favicon-96.png">
<link rel="icon" type="image/png" sizes="64x64" href="/public/favicon-64.png">
<link rel="icon" type="image/png" sizes="32x32" href="/public/favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/public/favicon-16.png">
<link rel="apple-touch-icon" href="/public/favicon-57.png">
<link rel="apple-touch-icon" sizes="180x180" href="/public/favicon-180.png">
<link rel="apple-touch-icon" sizes="152x152" href="/public/favicon-152.png">
<link rel="apple-touch-icon" sizes="144x144" href="/public/favicon-144.png">
<link rel="apple-touch-icon" sizes="120x120" href="/public/favicon-120.png">
<link rel="apple-touch-icon" sizes="114x114" href="/public/favicon-114.png">
<link rel="apple-touch-icon" sizes="76x76" href="/public/favicon-76.png">
<link rel="apple-touch-icon" sizes="72x72" href="/public/favicon-72.png">
<link rel="apple-touch-icon" sizes="60x60" href="/public/favicon-60.png">
<meta name="msapplication-TileColor" content="#FFFFFF">
<meta name="msapplication-TileImage" content="/public/favicon-144.png">
<meta name="msapplication-config" content="/public/browserconfig.xml">


  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Overriding instance method with a module" />
<meta name="author" content="Hrvoje Šimić" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This is the problem I come across every now and then, so I think a little write up explaining what&#39;s happening could help me understand it better." />
<meta property="og:description" content="This is the problem I come across every now and then, so I think a little write up explaining what&#39;s happening could help me understand it better." />
<link rel="canonical" href="http://shime.sh/overriding-instance-method-with-a-module" />
<meta property="og:url" content="http://shime.sh/overriding-instance-method-with-a-module" />
<meta property="og:site_name" content="Hrvoje Šimić" />
<meta property="og:image" content="http://shime.sh/public/social.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2012-08-06T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:image" content="http://shime.sh/public/social.png" />
<meta property="twitter:title" content="Overriding instance method with a module" />
<meta name="twitter:site" content="@shime_sh" />
<meta name="twitter:creator" content="@shime_sh" />
<script type="application/ld+json">
{"image":"http://shime.sh/public/social.png","headline":"Overriding instance method with a module","dateModified":"2012-08-06T00:00:00+02:00","datePublished":"2012-08-06T00:00:00+02:00","url":"http://shime.sh/overriding-instance-method-with-a-module","mainEntityOfPage":{"@type":"WebPage","@id":"http://shime.sh/overriding-instance-method-with-a-module"},"author":{"@type":"Person","name":"Hrvoje Šimić"},"description":"This is the problem I come across every now and then, so I think a little write up explaining what&#39;s happening could help me understand it better.","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  
    <title> Overriding instance method with a module &middot; Hrvoje Šimić </title>
  

  <meta name="title" content="Overriding instance method with a module &middot; Hrvoje Šimić">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.0/anchor.min.js"></script>

  
</head>


  <body class="font-sans">
    <div class="lg:pt-16 lg:pb-32 p-6 relative">
      




<div class="relative flex justify-between items-start w-full z-20 md:justify-center self-center">
  <div class="flex items-center">
    <a class="self-start w-16 h-16" href="/">
      <img class="self-start rounded-full w-16 h-16" src='/public/bw.jpeg' alt='' />
    </a>

    <div class="flex flex-col ml-4">
      <a class="text-black font-bold text-xl no-underline font-extrabold self-start" href="/">Hrvoje Šimić</a>
      <a class="text-black font-bold no-underline font-extrabold my-1 self-start" href="https://twitter.com/shime_sh">@shime_sh</a>
      <ul class="hidden md:block list-reset tracking-wide">
        
        <li class="inline">
          
          <a class="font-medium text-xs text-grey no-underline uppercase mr-2 hover:text-black" href='/articles/'>Articles</a>
          
        </li>
        
        <li class="inline">
          
          <a class="font-medium text-xs text-grey no-underline uppercase mr-2 hover:text-black" href='/til/'>TIL</a>
          
        </li>
        
        <li class="inline">
          
          <a class="font-medium text-xs text-grey no-underline uppercase mr-2 hover:text-black" href='/photography/'>Photography</a>
          
        </li>
        
        <li class="inline">
          
          <a class="font-medium text-xs text-grey no-underline uppercase mr-2 hover:text-black" href='/reading/'>Reading list</a>
          
        </li>
        
        <li class="inline">
          
          <a class="font-medium text-xs text-grey no-underline uppercase mr-2 hover:text-black" href='/subscribe'>Subscribe</a>
          
        </li>
        
      </ul>
    </div>
  </div>

  <div class="block md:hidden self-center">
    <button data-open-hamburger-menu="true">
      <svg height="32" width="32" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path fill="black" class="heroicon-ui" d="M4 5h16a1 1 0 0 1 0 2H4a1 1 0 1 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2z"/>
      </svg>
    </button>

    <button data-close-hamburger-menu="true" class="hidden">
      <svg fill="black" height="32" id="close" viewBox="0 0 32 32" width="32" xmlns="http://www.w3.org/2000/svg">
        <path d="M4 8 L8 4 L16 12 L24 4 L28 8 L20 16 L28 24 L24 28 L16 20 L8 28 L4 24 L12 16 z"/>
      </svg>
    </button>
  </div>
</div>

<div class="hidden md:hidden fixed pin bg-white z-10 mt-32 pt-12" data-hamburger-menu="true">
  <ul class="list-reset tracking-wide flex flex-col items-center w-full">
    

    <li class="my-2">
      
        <a class="font-semibold text-xl text-grey no-underline uppercase" href='/articles/'>Articles</a>
      
    </li>
    

    <li class="my-2">
      
        <a class="font-semibold text-xl text-grey no-underline uppercase" href='/til/'>TIL</a>
      
    </li>
    

    <li class="my-2">
      
        <a class="font-semibold text-xl text-grey no-underline uppercase" href='/photography/'>Photography</a>
      
    </li>
    

    <li class="my-2">
      
        <a class="font-semibold text-xl text-grey no-underline uppercase" href='/reading/'>Reading list</a>
      
    </li>
    

    <li class="my-2">
      
        <a class="font-semibold text-xl text-grey no-underline uppercase" href='/subscribe'>Subscribe</a>
      
    </li>
    
  </ul>
</div>


      <div class="w-full flex justify-center text-lg mt-16 text-grey-darker font-light leading-normal">
        <div class="flex-col">
          <div class="max-w-full">
            

          </div>

          <div class="post max-w-full md:max-w-md">
            
            

            <div>
              <a class="no-underline uppercase text-sm" href="/articles"> ← articles </a>
            </div>

            <div class="mb-8">
              <h1>Overriding instance method with a module</h1>
              
              <div class="text-grey">
                August 6, 2012
              </div>
              

              <div class="flex my-2">
                
                  <span class="bg-grey-lightest py-1 px-2 text-center text-grey-dark mr-2 rounded text-sm">
                    ruby
                  </span>
                
              </div>
            </div>

            <p>This is the problem I come across every now and then, so I think a little write up explaining what&#39;s happening could help me understand it better.</p>

<p>Let me describe the problem:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">module</span> <span class="nn">CanCook</span>
  <span class="k">def</span> <span class="nf">bake</span><span class="p">(</span><span class="n">food_name</span><span class="p">)</span>
    <span class="s2">&quot;I&#39;m baking the </span><span class="si">#{</span><span class="n">food_name</span><span class="si">}</span><span class="s2">!&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Programmer</span>
  <span class="k">def</span> <span class="nf">bake</span><span class="p">(</span><span class="n">food_name</span><span class="p">)</span>
    <span class="s2">&quot;I don&#39;t know how to bake </span><span class="si">#{</span><span class="n">food_name</span><span class="si">}</span><span class="s2"> :(&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Programmer</span>
  <span class="kp">include</span> <span class="no">CanCook</span>
<span class="k">end</span>

<span class="no">Mario</span> <span class="o">=</span> <span class="no">Programmer</span><span class="o">.</span><span class="n">new</span>
<span class="no">Mario</span><span class="o">.</span><span class="n">bake</span><span class="p">(</span><span class="s2">&quot;tortillas&quot;</span><span class="p">)</span> <span class="c1">#=&gt; I don&#39;t know how to bake tortillas :(</span>
</code></pre></div>
<p>Poor Mario doesn&#39;t know how to bake anything. We want to teach him how to bake, to stand out from other programmers!</p>

<p>The problem is described in the following diagram made by Gavin Kistner:</p>

<p><img src="http://i.stack.imgur.com/40zfE.png" alt=""></p>

<p>There&#39;s a <a href="http://stackoverflow.com/a/5944385/726020">post on StackOverflow</a> where Gavin presents workarounds for this. I&#39;m going to explain them and add some more:</p>

<h2>Subclass Programmer and then include module</h2>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">module</span> <span class="nn">CanCook</span>
  <span class="k">def</span> <span class="nf">bake</span><span class="p">(</span><span class="n">food_name</span><span class="p">)</span>
    <span class="s2">&quot;I&#39;m baking the </span><span class="si">#{</span><span class="n">food_name</span><span class="si">}</span><span class="s2">!&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Programmer</span>
  <span class="k">def</span> <span class="nf">bake</span><span class="p">(</span><span class="n">food_name</span><span class="p">)</span>
    <span class="s2">&quot;I don&#39;t know how to bake </span><span class="si">#{</span><span class="n">food_name</span><span class="si">}</span><span class="s2"> :(&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">CulinaryProgrammer</span> <span class="o">&lt;</span> <span class="no">Programmer</span>
  <span class="kp">include</span> <span class="no">CanCook</span>
<span class="k">end</span>

<span class="no">Mario</span> <span class="o">=</span> <span class="no">CulinaryProgrammer</span><span class="o">.</span><span class="n">new</span>
<span class="no">Mario</span><span class="o">.</span><span class="n">bake</span><span class="p">(</span><span class="s2">&quot;tortillas&quot;</span><span class="p">)</span> <span class="c1">#=&gt; I&#39;m baking the tortillas!</span>
</code></pre></div>
<p><em>What&#39;s wrong with this?</em></p>

<p>This isn&#39;t a real world example, just a simple one that describes this behavior. This would rarely fit you, since you now have to create instances of a new class that will fit your needs. In the real world, you would want instances of the original class to behave like this.</p>

<h2>Extend just the instances you need</h2>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">module</span> <span class="nn">CanCook</span>
  <span class="k">def</span> <span class="nf">bake</span><span class="p">(</span><span class="n">food_name</span><span class="p">)</span>
    <span class="s2">&quot;I&#39;m baking the </span><span class="si">#{</span><span class="n">food_name</span><span class="si">}</span><span class="s2">!&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Programmer</span>
  <span class="k">def</span> <span class="nf">bake</span><span class="p">(</span><span class="n">food_name</span><span class="p">)</span>
    <span class="s2">&quot;I don&#39;t know how to bake </span><span class="si">#{</span><span class="n">food_name</span><span class="si">}</span><span class="s2"> :(&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Mario</span> <span class="o">=</span> <span class="no">Programmer</span><span class="o">.</span><span class="n">new</span>
<span class="no">Mario</span><span class="o">.</span><span class="n">extend</span> <span class="no">CanCook</span>
<span class="no">Mario</span><span class="o">.</span><span class="n">bake</span><span class="p">(</span><span class="s2">&quot;tortillas&quot;</span><span class="p">)</span> <span class="c1">#=&gt; I&#39;m baking the tortillas!</span>
</code></pre></div>
<p><em>What&#39;s wrong with this?</em></p>

<p>This is better than the previous solution, it skips the part of inheriting the original class, but you still have to extend each instance. What happens with already used instances in your application?</p>

<h2>Perform a gross hack that removes the original method</h2>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">module</span> <span class="nn">CanCook</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
    <span class="n">base</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
      <span class="n">remove_method</span> <span class="ss">:bake</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">bake</span><span class="p">(</span><span class="n">food_name</span><span class="p">)</span>
    <span class="s2">&quot;I&#39;m baking the </span><span class="si">#{</span><span class="n">food_name</span><span class="si">}</span><span class="s2">!&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Programmer</span>
  <span class="k">def</span> <span class="nf">bake</span><span class="p">(</span><span class="n">food_name</span><span class="p">)</span>
    <span class="s2">&quot;I don&#39;t know how to bake </span><span class="si">#{</span><span class="n">food_name</span><span class="si">}</span><span class="s2"> :(&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Programmer</span>
  <span class="kp">include</span> <span class="no">CanCook</span>
<span class="k">end</span>

<span class="no">Mario</span> <span class="o">=</span> <span class="no">Programmer</span><span class="o">.</span><span class="n">new</span>
<span class="no">Mario</span><span class="o">.</span><span class="n">bake</span><span class="p">(</span><span class="s2">&quot;tortillas&quot;</span><span class="p">)</span> <span class="c1">#=&gt; I&#39;m baking the tortillas!</span>
</code></pre></div>
<p><em>What&#39;s wrong with this?</em></p>

<p>Just as Gavin describes it in his post, this strategy is invasive.
Your old method will be deleted and you will not going to be able to use it afterwards. This is the best solution so far, even though <em>remove_method</em> seems dirty.
The good part is that your instances of <em>Programmer</em> will now know how to bake things automatically. Hooray!</p>

<h2>No need to use module if using remove_method</h2>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">class</span> <span class="nc">Programmer</span>
  <span class="k">def</span> <span class="nf">bake</span><span class="p">(</span><span class="n">food_name</span><span class="p">)</span>
    <span class="s2">&quot;I don&#39;t know how to bake </span><span class="si">#{</span><span class="n">food_name</span><span class="si">}</span><span class="s2"> :(&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Programmer</span>
  <span class="n">alias_method</span> <span class="ss">:_real_bake</span><span class="p">,</span> <span class="ss">:bake</span>
  <span class="k">def</span> <span class="nf">bake</span><span class="p">(</span><span class="n">food_name</span><span class="p">)</span>
    <span class="s2">&quot;I&#39;m baking the </span><span class="si">#{</span><span class="n">food_name</span><span class="si">}</span><span class="s2">!&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Mario</span> <span class="o">=</span> <span class="no">Programmer</span><span class="o">.</span><span class="n">new</span>
<span class="no">Mario</span><span class="o">.</span><span class="n">bake</span><span class="p">(</span><span class="s2">&quot;tortillas&quot;</span><span class="p">)</span> <span class="c1">#=&gt; I&#39;m baking the tortillas!</span>
</code></pre></div>
<p><em>What&#39;s wrong with this?</em></p>

<p>This post describes modules overriding instance methods, that&#39;s what&#39;s wrong. :) It makes sense to not use the module, though.
The original method is preserved and available for later usage. However, this is not that clean.
Modules are used to describe behavior that can be shared between objects. This removes that flexibility.</p>

<p>Here&#39;s the alternative:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">module</span> <span class="nn">CanCook</span>
  <span class="k">def</span> <span class="nf">override_bake</span><span class="p">(</span><span class="n">food_name</span><span class="p">)</span>
    <span class="s2">&quot;I&#39;m baking the </span><span class="si">#{</span><span class="n">food_name</span><span class="si">}</span><span class="s2">!&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Programmer</span>
  <span class="k">def</span> <span class="nf">bake</span><span class="p">(</span><span class="n">food_name</span><span class="p">)</span>
    <span class="s2">&quot;I don&#39;t know how to bake </span><span class="si">#{</span><span class="n">food_name</span><span class="si">}</span><span class="s2"> :(&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Programmer</span>
  <span class="kp">include</span> <span class="no">CanCook</span>
  <span class="n">alias_method</span> <span class="ss">:bake</span><span class="p">,</span> <span class="ss">:override_bake</span>
<span class="k">end</span>

<span class="no">Mario</span> <span class="o">=</span> <span class="no">Programmer</span><span class="o">.</span><span class="n">new</span>
<span class="no">Mario</span><span class="o">.</span><span class="n">bake</span><span class="p">(</span><span class="s2">&quot;tortillas&quot;</span><span class="p">)</span> <span class="c1">#=&gt; I&#39;m baking the tortillas!</span>
</code></pre></div>
<p>I like this more since it still preserves the original, but we&#39;re still using a module, even though the methods don&#39;t share the name.</p>

<h2>Use (prepend) library by John Mair</h2>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="nb">require</span> <span class="s2">&quot;prepend&quot;</span>
<span class="k">module</span> <span class="nn">CanCook</span>
  <span class="k">def</span> <span class="nf">bake</span><span class="p">(</span><span class="n">food_name</span><span class="p">)</span>
    <span class="s2">&quot;I&#39;m baking the </span><span class="si">#{</span><span class="n">food_name</span><span class="si">}</span><span class="s2">!&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Programmer</span>
  <span class="k">def</span> <span class="nf">bake</span><span class="p">(</span><span class="n">food_name</span><span class="p">)</span>
    <span class="s2">&quot;I don&#39;t know how to bake </span><span class="si">#{</span><span class="n">food_name</span><span class="si">}</span><span class="s2"> :(&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Programmer</span>
  <span class="n">prepend</span> <span class="no">CanCook</span>
<span class="k">end</span>

<span class="no">Mario</span> <span class="o">=</span> <span class="no">Programmer</span><span class="o">.</span><span class="n">new</span>
<span class="no">Mario</span><span class="o">.</span><span class="n">bake</span><span class="p">(</span><span class="s2">&quot;tortillas&quot;</span><span class="p">)</span> <span class="c1">#=&gt; I&#39;m baking the tortillas!</span>
</code></pre></div>
<p><em>What&#39;s wrong with this?</em></p>

<p>It&#39;s depending on external library.</p>

<h2>The ultimate solution of them all</h2>

<p>These are all the solutions presented in that SO post,
but we haven&#39;t yet found the ultimate one.
Does any of these make you jump around your room screaming how great this code is?
I didn&#39;t think so.</p>

<p>But behold! This is the solution by <a href="https://github.com/rkh">@rkh</a> which pretty much encapsulates why I love his work.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">module</span> <span class="nn">Prepending</span>
  <span class="k">def</span> <span class="nf">append_features</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
    <span class="n">prepend</span> <span class="o">=</span> <span class="nb">self</span>
    <span class="n">base</span><span class="o">.</span><span class="n">extend</span> <span class="no">Module</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="n">define_method</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span> <span class="p">{</span> <span class="o">|*</span><span class="n">args</span><span class="p">,</span><span class="o">&amp;</span><span class="n">block</span><span class="o">|</span> <span class="k">super</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">prepend</span><span class="p">)</span> <span class="p">}}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">CanCook</span>

  <span class="kp">extend</span> <span class="no">Prepending</span>

  <span class="k">def</span> <span class="nf">bake</span><span class="p">(</span><span class="n">food_name</span><span class="p">)</span>
    <span class="s2">&quot;I&#39;m baking the </span><span class="si">#{</span><span class="n">food_name</span><span class="si">}</span><span class="s2">!&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Programmer</span>
  <span class="k">def</span> <span class="nf">bake</span><span class="p">(</span><span class="n">food_name</span><span class="p">)</span>
    <span class="s2">&quot;I don&#39;t know how to bake </span><span class="si">#{</span><span class="n">food_name</span><span class="si">}</span><span class="s2"> :(&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Programmer</span>
  <span class="kp">include</span> <span class="no">CanCook</span>
<span class="k">end</span>

<span class="no">Mario</span> <span class="o">=</span> <span class="no">Programmer</span><span class="o">.</span><span class="n">new</span>
<span class="no">Mario</span><span class="o">.</span><span class="n">bake</span><span class="p">(</span><span class="s2">&quot;tortillas&quot;</span><span class="p">)</span> <span class="c1">#=&gt; I&#39;m baking the tortillas!</span>
</code></pre></div>
<p>I&#39;m going to describe this solution in detail, so if you&#39;re not amazed, this post will not get any more interesting.</p>

<p>So where to begin?</p>

<ul>
<li>Any external dependencies? No.</li>
<li>Are we getting invasive on original method? No.</li>
<li>Do we have to do something special with the instances we would like to have the method overridden? Not at all.</li>
<li>Is this code awesome? Hell yeah!</li>
</ul>

<p>Isn&#39;t this what you first think of when you wish to override instance method with a module?</p>

<p>Okay, enough with the praising, let&#39;s start explaining!
Our code is nicely organised, but the whole beauty lays in a module named <em>Prepending</em>. All logic needed to prepend instance methods is located there.</p>

<p>From ruby documentation:</p>

<blockquote>
<p>append_features(p1)</p>

<p>When this module is included in another, Ruby calls append_features in
   this module, passing it the receiving module in mod.</p>
</blockquote>

<p>Documentation is somewhat confusing. This method will get called even when the module is included in a class, since Class inherits from Module.
In our code it happens when we include CanCook into Programmer on line 24.</p>

<p>Note that self will refer to CanCook, and base will refer to Programmer class.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span>    <span class="n">prepend</span> <span class="o">=</span> <span class="nb">self</span>
</code></pre></div>
<p><em>Save this module to a variable, so we can use it later.</em></p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="n">base</span><span class="o">.</span><span class="n">extend</span> <span class="no">Module</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="n">define_method</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span> <span class="p">{</span> <span class="o">|*</span><span class="n">args</span><span class="p">,</span><span class="o">&amp;</span><span class="n">block</span><span class="o">|</span> <span class="k">super</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">prepend</span><span class="p">)</span> <span class="p">}}</span>
</code></pre></div>
<h2>Extend the Programmer class with anonymous module</h2>

<p>This is somewhat more expressive:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">module</span> <span class="nn">Prepending</span>
  <span class="k">def</span> <span class="nf">append_features</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
    <span class="n">prepend</span> <span class="o">=</span> <span class="nb">self</span>
    <span class="n">beauty</span> <span class="o">=</span> <span class="no">Module</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
      <span class="n">define_method</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span> <span class="k">do</span> <span class="o">|*</span><span class="n">args</span><span class="p">,</span><span class="o">&amp;</span><span class="n">block</span><span class="o">|</span>
        <span class="k">super</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">prepend</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">base</span><span class="o">.</span><span class="n">extend</span> <span class="n">beauty</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><em>Why are we using anonymous module here?</em></p>

<p>By defining the module and the method in block, we stay in the same lexical closure, so we can access the local variables.</p>

<p><em>What is wrong with this line of code?</em></p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">module</span> <span class="nn">Prepending</span>
  <span class="k">def</span> <span class="nf">append_features</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
    <span class="n">prepend</span> <span class="o">=</span> <span class="nb">self</span>
    <span class="n">beauty</span> <span class="o">=</span> <span class="no">Module</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span>
      <span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
        <span class="k">super</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">prepend</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">base</span><span class="o">.</span><span class="n">extend</span> <span class="n">beauty</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p><em>prepend</em> doesn&#39;t exist in the context of the <em>new</em> method, since it&#39;s a local variable. We have to define a method dynamically to make it available by preserving original context.</p>

<p>Okay, let&#39;s explain the code inside this dynamically created method.
It&#39;s called <em>new</em> and it overrides a Programmer&#39;s constructor, so when <em>Programmer.new</em> is called, this method will get called instead.</p>

<p>It calls the original constructor with <em>super</em>,
which returns a new instance of Programmer and then extends it dynamically with itself (this module, or the module that extends this module).
This enables overriding instance methods.</p>

<h2>Update</h2>

<p>Thank you all for discussing this post and sharing your opinions.</p>

<p><a href="https://github.com/ryanlecompte">Ryan LeCompte</a> has another, more easily understandable solution.
Instead of using an anonymous module, we could simply use <em>define<em>singleton</em>method</em>.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">module</span> <span class="nn">Prepending</span>
  <span class="k">def</span> <span class="nf">append_features</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
    <span class="n">prepend</span> <span class="o">=</span> <span class="nb">self</span>
    <span class="n">base</span><span class="o">.</span><span class="n">define_singleton_method</span><span class="p">(</span><span class="ss">:new</span><span class="p">)</span> <span class="k">do</span> <span class="o">|*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="o">|</span>
      <span class="k">super</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">prepend</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">CanCook</span>

  <span class="kp">extend</span> <span class="no">Prepending</span>

  <span class="k">def</span> <span class="nf">bake</span><span class="p">(</span><span class="n">food_name</span><span class="p">)</span>
    <span class="s2">&quot;I&#39;m baking the </span><span class="si">#{</span><span class="n">food_name</span><span class="si">}</span><span class="s2">!&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Programmer</span>
  <span class="k">def</span> <span class="nf">bake</span><span class="p">(</span><span class="n">food_name</span><span class="p">)</span>
    <span class="s2">&quot;I don&#39;t know how to bake </span><span class="si">#{</span><span class="n">food_name</span><span class="si">}</span><span class="s2"> :(&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>


<span class="k">class</span> <span class="nc">Programmer</span>
  <span class="kp">include</span> <span class="no">CanCook</span>
<span class="k">end</span>

<span class="no">Mario</span> <span class="o">=</span> <span class="no">Programmer</span><span class="o">.</span><span class="n">new</span>
<span class="no">Mario</span><span class="o">.</span><span class="n">bake</span><span class="p">(</span><span class="s2">&quot;tortillas&quot;</span><span class="p">)</span> <span class="c1">#=&gt; I&#39;m baking the tortillas!</span>
</code></pre></div>
<p>As Markus explains, we could have extended the instance directly in a constructor.</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">module</span> <span class="nn">CanCook</span>
  <span class="k">def</span> <span class="nf">bake</span><span class="p">(</span><span class="n">food_name</span><span class="p">)</span>
    <span class="s2">&quot;I&#39;m baking the </span><span class="si">#{</span><span class="n">food_name</span><span class="si">}</span><span class="s2">!&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Programmer</span>
  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">extend</span> <span class="no">CanCook</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">bake</span><span class="p">(</span><span class="n">food_name</span><span class="p">)</span>
    <span class="s2">&quot;I don&#39;t know how to bake </span><span class="si">#{</span><span class="n">food_name</span><span class="si">}</span><span class="s2"> :(&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Mario</span> <span class="o">=</span> <span class="no">Programmer</span><span class="o">.</span><span class="n">new</span>
<span class="no">Mario</span><span class="o">.</span><span class="n">bake</span><span class="p">(</span><span class="s2">&quot;tortillas&quot;</span><span class="p">)</span> <span class="c1">#=&gt; I&#39;m baking the tortillas!</span>
</code></pre></div>
<p><a href="http://twitter.com/hanke">Florian Hanke</a> explains that this code doesn&#39;t express its intent very well and I couldn&#39;t agree more with him.
I was very excited when I first saw Konstantin Haase&#39;s technique of achieving this behavior (here is the original <a href="https://gist.github.com/2720016">gist</a>).
I&#39;ve written this post with the intent of describing that interesting technique. I didn&#39;t analyse possible future usages.</p>

<p>You should also read an <a href="http://blog.8thlight.com/josh-cheek/2012/02/03/modules-called-they-want-their-integrity-back.html">interesting post</a> by Josh Cheek about dangers of using hooks.</p>

<p>Finally, thanks to <a href="https://twitter.com/neektza">Nikica</a> for a suggestion about lexical context.</p>



            
              <div class="mt-12 bg-grey-lightest p-8 text-grey-darkest border-t-4 border-grey-light">
                


<p class="mt-4 max-w-sm m-auto">
  I send a newsletter called Regular Reveries every Wednesday. It consists of four sections:
  this week's article, the best of what I've read in a week, a quote that resonated with me, and a question for you.

  <div class="mt-8">
    <form
       action="https://buttondown.email/api/emails/embed-subscribe/shime"
       method="post"
       target="popupwindow"
       onsubmit="window.open('https://buttondown.email/shime', 'popupwindow')"
       class="embeddable-buttondown-form"
       >
       <div class="flex max-w-sm m-auto">
         <input type="email" name="email" id="bd-email" class="bg-white appearance-none rounded rounded-r-none w-full py-2 px-4 text-grey-darker leading-tight focus:outline-none"  placeholder="you@domain.com">
         <input type="hidden" value="1" name="embed"></input>
         
         <input type="submit" value="Subscribe" class="cursor-pointer shadow bg-black hover:bg-grey-darkest focus:outline-none text-white font-bold py-2 px-4 rounded rounded-l-none"></input>
       </div>
       <div class="flex justify-center text-xs max-w-sm m-auto"><span>Unsubscribe anytime. By submitting your email, you agree to our <a href="/privacy">privacy policy</a>.</span></div>
     </form>
  </div>
</p>

              </div>
            
          </div>
        </div>
      </div>
    </div>
  </body>

  <script>
  var menu = document.querySelectorAll('[data-hamburger-menu]')[0]
  var openMenu = document.querySelectorAll('[data-open-hamburger-menu]')[0]
  var closeMenu = document.querySelectorAll('[data-close-hamburger-menu]')[0]
  var body = document.body

  openMenu.onclick = toggleMenu.bind(this, true);
  closeMenu.onclick = toggleMenu.bind(this, false);

  function toggleMenu(show) {
    toggleElements([openMenu], !show);
    toggleElements([menu, closeMenu], show);
    toggleScrolling(body, show);
  }

  function toggleElements(elements, show) {
    elements.forEach(function(element) {
      if (show) {
        element.classList.remove("hidden")
        element.classList.add("block");
      } else {
        element.classList.remove("block")
        element.classList.add("hidden");
      }
    })
  }

  function toggleScrolling(element, scrollDisabled) {
    var classes = ["scrolling-auto", "overflow-hidden", "fixed", "pin-x"];
    if (scrollDisabled) {
      classes.forEach(function(klass){
        element.classList.add(klass);
      })
    } else {
      classes.forEach(function(klass){
        element.classList.remove(klass);
      })
    }
  }

  var anchors = new AnchorJS();
  anchors.options = {
    placement: 'left'
  }
  anchors.add()
</script>

</html>
