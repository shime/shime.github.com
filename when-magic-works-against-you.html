<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="//gmpg.org/xfn/11" rel="profile">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/monokai.css?1607892750498780000">
  <link rel="stylesheet" href="/public/css/style.css?1607892750498780000">

  <link rel="icon" sizes="16x16 32x32 64x64" href="/public/favicon.ico">
<link rel="icon" type="image/png" sizes="196x196" href="/public/favicon-196.png">
<link rel="icon" type="image/png" sizes="160x160" href="/public/favicon-160.png">
<link rel="icon" type="image/png" sizes="128x128" href="/public/favicon-128.png">
<link rel="icon" type="image/png" sizes="96x96" href="/public/favicon-96.png">
<link rel="icon" type="image/png" sizes="64x64" href="/public/favicon-64.png">
<link rel="icon" type="image/png" sizes="32x32" href="/public/favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/public/favicon-16.png">
<link rel="apple-touch-icon" href="/public/favicon-57.png">
<link rel="apple-touch-icon" sizes="180x180" href="/public/favicon-180.png">
<link rel="apple-touch-icon" sizes="152x152" href="/public/favicon-152.png">
<link rel="apple-touch-icon" sizes="144x144" href="/public/favicon-144.png">
<link rel="apple-touch-icon" sizes="120x120" href="/public/favicon-120.png">
<link rel="apple-touch-icon" sizes="114x114" href="/public/favicon-114.png">
<link rel="apple-touch-icon" sizes="76x76" href="/public/favicon-76.png">
<link rel="apple-touch-icon" sizes="72x72" href="/public/favicon-72.png">
<link rel="apple-touch-icon" sizes="60x60" href="/public/favicon-60.png">
<meta name="msapplication-TileColor" content="#FFFFFF">
<meta name="msapplication-TileImage" content="/public/favicon-144.png">
<meta name="msapplication-config" content="/public/browserconfig.xml">


  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="When magic works against you" />
<meta name="author" content="Hrvoje Šimić" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="When I first encountered this concern in the Rails app that I was working on, I was initially impressed. It felt like magic. Like a cool trick to avoid unnecessary complexity." />
<meta property="og:description" content="When I first encountered this concern in the Rails app that I was working on, I was initially impressed. It felt like magic. Like a cool trick to avoid unnecessary complexity." />
<link rel="canonical" href="http://shime.sh/when-magic-works-against-you" />
<meta property="og:url" content="http://shime.sh/when-magic-works-against-you" />
<meta property="og:site_name" content="Hrvoje Šimić" />
<meta property="og:image" content="http://shime.sh/public/social.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-11-22T00:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:image" content="http://shime.sh/public/social.png" />
<meta property="twitter:title" content="When magic works against you" />
<meta name="twitter:site" content="@shime_sh" />
<meta name="twitter:creator" content="@shime_sh" />
<script type="application/ld+json">
{"image":"http://shime.sh/public/social.png","headline":"When magic works against you","dateModified":"2020-11-22T00:00:00+01:00","datePublished":"2020-11-22T00:00:00+01:00","url":"http://shime.sh/when-magic-works-against-you","mainEntityOfPage":{"@type":"WebPage","@id":"http://shime.sh/when-magic-works-against-you"},"author":{"@type":"Person","name":"Hrvoje Šimić"},"description":"When I first encountered this concern in the Rails app that I was working on, I was initially impressed. It felt like magic. Like a cool trick to avoid unnecessary complexity.","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  
    <title> When magic works against you &middot; Hrvoje Šimić </title>
  

  <meta name="title" content="When magic works against you &middot; Hrvoje Šimić">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.0/anchor.min.js"></script>

  
</head>


  <body class="font-sans">
    <div class="lg:pt-16 lg:pb-32 p-6 relative">
      




<div class="relative flex justify-between items-start w-full z-20 md:justify-center self-center">
  <div class="flex items-center">
    <a class="self-start w-16 h-16" href="/">
      <img class="self-start rounded-full w-16 h-16" src='/public/bw.jpeg' alt='' />
    </a>

    <div class="flex flex-col ml-4">
      <a class="text-black font-bold text-xl no-underline font-extrabold self-start" href="/">Hrvoje Šimić</a>
      <a class="text-black font-bold no-underline font-extrabold my-1 self-start" href="https://twitter.com/shime_sh">@shime_sh</a>
      <ul class="hidden md:block list-reset tracking-wide">
        
        <li class="inline">
          
          <a class="font-medium text-xs text-grey no-underline uppercase mr-2 hover:text-black" href='/articles/'>Articles</a>
          
        </li>
        
        <li class="inline">
          
          <a class="font-medium text-xs text-grey no-underline uppercase mr-2 hover:text-black" href='/til/'>TIL</a>
          
        </li>
        
        <li class="inline">
          
          <a class="font-medium text-xs text-grey no-underline uppercase mr-2 hover:text-black" href='/photography/'>Photography</a>
          
        </li>
        
        <li class="inline">
          
          <a class="font-medium text-xs text-grey no-underline uppercase mr-2 hover:text-black" href='/reading/'>Reading list</a>
          
        </li>
        
        <li class="inline">
          
          <a class="font-medium text-xs text-grey no-underline uppercase mr-2 hover:text-black" href='/subscribe'>Subscribe</a>
          
        </li>
        
      </ul>
    </div>
  </div>

  <div class="block md:hidden self-center">
    <button data-open-hamburger-menu="true">
      <svg height="32" width="32" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path fill="black" class="heroicon-ui" d="M4 5h16a1 1 0 0 1 0 2H4a1 1 0 1 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2z"/>
      </svg>
    </button>

    <button data-close-hamburger-menu="true" class="hidden">
      <svg fill="black" height="32" id="close" viewBox="0 0 32 32" width="32" xmlns="http://www.w3.org/2000/svg">
        <path d="M4 8 L8 4 L16 12 L24 4 L28 8 L20 16 L28 24 L24 28 L16 20 L8 28 L4 24 L12 16 z"/>
      </svg>
    </button>
  </div>
</div>

<div class="hidden md:hidden fixed pin bg-white z-10 mt-32 pt-12" data-hamburger-menu="true">
  <ul class="list-reset tracking-wide flex flex-col items-center w-full">
    

    <li class="my-2">
      
        <a class="font-semibold text-xl text-grey no-underline uppercase" href='/articles/'>Articles</a>
      
    </li>
    

    <li class="my-2">
      
        <a class="font-semibold text-xl text-grey no-underline uppercase" href='/til/'>TIL</a>
      
    </li>
    

    <li class="my-2">
      
        <a class="font-semibold text-xl text-grey no-underline uppercase" href='/photography/'>Photography</a>
      
    </li>
    

    <li class="my-2">
      
        <a class="font-semibold text-xl text-grey no-underline uppercase" href='/reading/'>Reading list</a>
      
    </li>
    

    <li class="my-2">
      
        <a class="font-semibold text-xl text-grey no-underline uppercase" href='/subscribe'>Subscribe</a>
      
    </li>
    
  </ul>
</div>


      <div class="w-full flex justify-center text-lg mt-16 text-grey-darker font-light leading-normal">
        <div class="flex-col">
          <div class="max-w-full">
            

          </div>

          <div class="post max-w-full md:max-w-md">
            
            

            <div>
              <a class="no-underline uppercase text-sm" href="/articles"> ← articles </a>
            </div>

            <div class="mb-8">
              <h1>When magic works against you</h1>
              
              <div class="text-grey">
                November 22, 2020
              </div>
              

              <div class="flex my-2">
                
              </div>
            </div>

            <p>When I first encountered this concern in the Rails app that I was working on, I was initially impressed. It felt like magic. Like a cool trick to avoid unnecessary complexity.</p>

<p>This concern enabled using <code>let</code>  in Rails controllers. It inverts the relationship between controllers and views, so instead of controllers providing data for the views, it makes views ask for data from controllers. <a href="https://medium.com/@eric.programmer/removing-the-hack-in-rails-controllers-52396463c40d">This post shows the reasoning behind it</a>, and I will refer to it as “original post” in this article.</p>

<p>This is the example from the original post:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">class</span> <span class="nc">WidgetsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:widgets</span><span class="p">)</span> <span class="p">{</span> <span class="no">Widget</span><span class="o">.</span><span class="n">all</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:widget</span><span class="p">)</span> <span class="p">{</span> <span class="n">widgets</span><span class="o">.</span><span class="n">find_or_initialize_by</span> <span class="nb">id</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span> <span class="p">}</span>

  <span class="k">def</span> <span class="nf">new</span>
    <span class="n">render</span> <span class="ss">:form</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">edit</span>
    <span class="n">render</span> <span class="ss">:form</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">save</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update</span>
    <span class="n">save</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">destroy</span>
    <span class="n">redirect_to</span> <span class="n">widgets_url</span><span class="p">,</span>
                <span class="ss">notice</span><span class="p">:</span> <span class="s2">&quot;Widget was successfully destroyed.&quot;</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">save</span>
    <span class="k">if</span> <span class="n">widget</span><span class="o">.</span><span class="n">update</span> <span class="n">secure_params</span>
      <span class="n">redirect_to</span> <span class="n">widget</span><span class="p">,</span>
                  <span class="ss">notice</span><span class="p">:</span> <span class="s2">&quot;Widget was successfully saved.&quot;</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">:form</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">secure_params</span>
    <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:widget</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span> <span class="ss">:name</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>With this, the templates would simply use <code>widget</code>:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="o">&lt;%=</span> <span class="n">widget</span><span class="o">.</span><span class="n">name</span> <span class="o">%&gt;</span>
</code></pre></div>
<p>However, there are a lot of problems with this approach.</p>

<h2>1. It’s implicit</h2>

<p>There’s a reason why ActiveRecord callbacks are not a great idea and why you should prefer not passing instance variables to your views. The Zen of Python famously generalizes this rule as “explicit is better than implicit”.</p>

<p>Code that relies too much on magic is too difficult to understand and therefore maintain. I would rather have duplication that is visible and easy to understand than DRY magic that is hard to understand.</p>

<h2>2. It’s a fake local</h2>

<p>The original post sees passing instance variables to views as an improvement of explicitly passing locals. (I strongly disagree because I find views with instance variables hard to maintain.)</p>

<p><code>let</code> is more implicit than using instance variables. It suffers from the same problems as using instance variables since it uses instance variables under the hood. It makes views too dependent on their controllers. Partials become difficult to move around.</p>

<p><code>let</code> adds another problem and makes it more difficult for the reader to understand that this is, in fact, a memoized instance variable.</p>

<p>It’s a memoized instance variable masquerading as a local.</p>

<p>So, just adding this concern into your application controller, as the author suggests in his original post, makes all of your views more difficult to understand.</p>

<p>Seeing:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="o">&lt;%=</span> <span class="n">user</span> <span class="o">%&gt;</span>
</code></pre></div>
<p>In any of your views makes it difficult to track down. Is it a local or an instance variable?</p>

<h2>3. It’s easy to make mistakes</h2>

<p>If you’re not careful, you can easily open a can of worms. One example is using <code>let</code> inside the application controller. Here’s an example:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">include</span> <span class="no">Lettable</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span> <span class="k">if</span> <span class="n">params</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">].</span><span class="n">present?</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Good luck tracking where <code>user</code> comes from in hundreds of your views or controllers.</p>

<p class="text-center">
*  *  * 
</p>

<p>So, by introducing the Lettable concern, you end up with somewhat cleaner controllers and views that become hard to understand. You avoid the issue of accidentally loading data for actions that don’t need it, as mentioned in the original post, but it makes your life much harder when it comes to maintenance.</p>

<p>Beware of the long term consequences of including cool tricks in your codebase. They might temporarily solve smaller problems but sometimes cause even bigger problems. What starts as magic can end tragic.</p>



            
              <div class="mt-12 bg-grey-lightest p-8 text-grey-darkest border-t-4 border-grey-light">
                


<p class="mt-4 max-w-sm m-auto">
  I send a newsletter called Regular Reveries every Wednesday. It consists of four sections:
  this week's article, the best of what I've read in a week, a quote that resonated with me, and a question for you.

  <div class="mt-8">
    <form
       action="https://buttondown.email/api/emails/embed-subscribe/shime"
       method="post"
       target="popupwindow"
       onsubmit="window.open('https://buttondown.email/shime', 'popupwindow')"
       class="embeddable-buttondown-form"
       >
       <div class="flex max-w-sm m-auto">
         <input type="email" name="email" id="bd-email" class="bg-white appearance-none rounded rounded-r-none w-full py-2 px-4 text-grey-darker leading-tight focus:outline-none"  placeholder="you@domain.com">
         <input type="hidden" value="1" name="embed"></input>
         
         <input type="submit" value="Subscribe" class="cursor-pointer shadow bg-black hover:bg-grey-darkest focus:outline-none text-white font-bold py-2 px-4 rounded rounded-l-none"></input>
       </div>
       <div class="flex justify-center text-xs max-w-sm m-auto"><span>Unsubscribe anytime. By submitting your email, you agree to our <a href="/privacy">privacy policy</a>.</span></div>
     </form>
  </div>
</p>

              </div>
            
          </div>
        </div>
      </div>
    </div>
  </body>

  <script>
  var menu = document.querySelectorAll('[data-hamburger-menu]')[0]
  var openMenu = document.querySelectorAll('[data-open-hamburger-menu]')[0]
  var closeMenu = document.querySelectorAll('[data-close-hamburger-menu]')[0]
  var body = document.body

  openMenu.onclick = toggleMenu.bind(this, true);
  closeMenu.onclick = toggleMenu.bind(this, false);

  function toggleMenu(show) {
    toggleElements([openMenu], !show);
    toggleElements([menu, closeMenu], show);
    toggleScrolling(body, show);
  }

  function toggleElements(elements, show) {
    elements.forEach(function(element) {
      if (show) {
        element.classList.remove("hidden")
        element.classList.add("block");
      } else {
        element.classList.remove("block")
        element.classList.add("hidden");
      }
    })
  }

  function toggleScrolling(element, scrollDisabled) {
    var classes = ["scrolling-auto", "overflow-hidden", "fixed", "pin-x"];
    if (scrollDisabled) {
      classes.forEach(function(klass){
        element.classList.add(klass);
      })
    } else {
      classes.forEach(function(klass){
        element.classList.remove(klass);
      })
    }
  }

  var anchors = new AnchorJS();
  anchors.options = {
    placement: 'left'
  }
  anchors.add()
</script>

</html>
