<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <link href="//gmpg.org/xfn/11" rel="profile">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/monokai.css?1601838492411126000">
  <link rel="stylesheet" href="/public/css/style.css?1601838492411126000">

  <link rel="icon" sizes="16x16 32x32 64x64" href="/public/favicon.ico">
<link rel="icon" type="image/png" sizes="196x196" href="/public/favicon-196.png">
<link rel="icon" type="image/png" sizes="160x160" href="/public/favicon-160.png">
<link rel="icon" type="image/png" sizes="128x128" href="/public/favicon-128.png">
<link rel="icon" type="image/png" sizes="96x96" href="/public/favicon-96.png">
<link rel="icon" type="image/png" sizes="64x64" href="/public/favicon-64.png">
<link rel="icon" type="image/png" sizes="32x32" href="/public/favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/public/favicon-16.png">
<link rel="apple-touch-icon" href="/public/favicon-57.png">
<link rel="apple-touch-icon" sizes="180x180" href="/public/favicon-180.png">
<link rel="apple-touch-icon" sizes="152x152" href="/public/favicon-152.png">
<link rel="apple-touch-icon" sizes="144x144" href="/public/favicon-144.png">
<link rel="apple-touch-icon" sizes="120x120" href="/public/favicon-120.png">
<link rel="apple-touch-icon" sizes="114x114" href="/public/favicon-114.png">
<link rel="apple-touch-icon" sizes="76x76" href="/public/favicon-76.png">
<link rel="apple-touch-icon" sizes="72x72" href="/public/favicon-72.png">
<link rel="apple-touch-icon" sizes="60x60" href="/public/favicon-60.png">
<meta name="msapplication-TileColor" content="#FFFFFF">
<meta name="msapplication-TileImage" content="/public/favicon-144.png">
<meta name="msapplication-config" content="/public/browserconfig.xml">


  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Refactoring a large case statement" />
<meta name="author" content="Hrvoje Šimić" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I&#39;m currently building a gem for converting curl commands to something else, and one early problem I needed to deal with was parsing the curl command arguments." />
<meta property="og:description" content="I&#39;m currently building a gem for converting curl commands to something else, and one early problem I needed to deal with was parsing the curl command arguments." />
<link rel="canonical" href="http://shime.sh/til/refactoring-a-large-case-statement" />
<meta property="og:url" content="http://shime.sh/til/refactoring-a-large-case-statement" />
<meta property="og:site_name" content="Hrvoje Šimić" />
<meta property="og:image" content="http://shime.sh/public/social.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-02-03T00:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:image" content="http://shime.sh/public/social.png" />
<meta property="twitter:title" content="Refactoring a large case statement" />
<meta name="twitter:site" content="@shime_sh" />
<meta name="twitter:creator" content="@shime_sh" />
<script type="application/ld+json">
{"image":"http://shime.sh/public/social.png","headline":"Refactoring a large case statement","dateModified":"2019-02-03T00:00:00+01:00","datePublished":"2019-02-03T00:00:00+01:00","url":"http://shime.sh/til/refactoring-a-large-case-statement","mainEntityOfPage":{"@type":"WebPage","@id":"http://shime.sh/til/refactoring-a-large-case-statement"},"author":{"@type":"Person","name":"Hrvoje Šimić"},"description":"I&#39;m currently building a gem for converting curl commands to something else, and one early problem I needed to deal with was parsing the curl command arguments.","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  
    <title> Refactoring a large case statement &middot; Hrvoje Šimić </title>
  

  <meta name="title" content="Refactoring a large case statement &middot; Hrvoje Šimić">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.0/anchor.min.js"></script>

  
</head>


  <body class="font-sans">
    <div class="lg:pt-16 lg:pb-32 p-6 relative">
      




<div class="relative flex justify-between items-start w-full z-20 md:justify-center self-center">
  <div class="flex items-center">
    <a class="self-start w-16 h-16" href="/">
      <img class="self-start rounded-full w-16 h-16" src='/public/bw.jpeg' alt='' />
    </a>

    <div class="flex flex-col ml-4">
      <a class="text-black font-bold text-xl no-underline font-extrabold self-start" href="/">Hrvoje Šimić</a>
      <a class="text-black font-bold no-underline font-extrabold my-1 self-start" href="https://twitter.com/shime_sh">@shime_sh</a>
      <ul class="hidden md:block list-reset tracking-wide">
        
        <li class="inline">
          
          <a class="font-medium text-xs text-grey no-underline uppercase mr-2 hover:text-black" href='/articles/'>Articles</a>
          
        </li>
        
        <li class="inline">
          
          <a class="font-medium text-xs text-grey no-underline uppercase mr-2 hover:text-black" href='/til/'>TIL</a>
          
        </li>
        
        <li class="inline">
          
          <a class="font-medium text-xs text-grey no-underline uppercase mr-2 hover:text-black" href='/photography/'>Photography</a>
          
        </li>
        
        <li class="inline">
          
          <a class="font-medium text-xs text-grey no-underline uppercase mr-2 hover:text-black" href='/reading/'>Reading list</a>
          
        </li>
        
        <li class="inline">
          
          <a class="font-medium text-xs text-grey no-underline uppercase mr-2 hover:text-black" href='/subscribe'>Subscribe</a>
          
        </li>
        
      </ul>
    </div>
  </div>

  <div class="block md:hidden self-center">
    <button data-open-hamburger-menu="true">
      <svg height="32" width="32" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path fill="black" class="heroicon-ui" d="M4 5h16a1 1 0 0 1 0 2H4a1 1 0 1 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2z"/>
      </svg>
    </button>

    <button data-close-hamburger-menu="true" class="hidden">
      <svg fill="black" height="32" id="close" viewBox="0 0 32 32" width="32" xmlns="http://www.w3.org/2000/svg">
        <path d="M4 8 L8 4 L16 12 L24 4 L28 8 L20 16 L28 24 L24 28 L16 20 L8 28 L4 24 L12 16 z"/>
      </svg>
    </button>
  </div>
</div>

<div class="hidden md:hidden fixed pin bg-white z-10 mt-32 pt-12" data-hamburger-menu="true">
  <ul class="list-reset tracking-wide flex flex-col items-center w-full">
    

    <li class="my-2">
      
        <a class="font-semibold text-xl text-grey no-underline uppercase" href='/articles/'>Articles</a>
      
    </li>
    

    <li class="my-2">
      
        <a class="font-semibold text-xl text-grey no-underline uppercase" href='/til/'>TIL</a>
      
    </li>
    

    <li class="my-2">
      
        <a class="font-semibold text-xl text-grey no-underline uppercase" href='/photography/'>Photography</a>
      
    </li>
    

    <li class="my-2">
      
        <a class="font-semibold text-xl text-grey no-underline uppercase" href='/reading/'>Reading list</a>
      
    </li>
    

    <li class="my-2">
      
        <a class="font-semibold text-xl text-grey no-underline uppercase" href='/subscribe'>Subscribe</a>
      
    </li>
    
  </ul>
</div>


      <div class="w-full flex justify-center text-lg mt-16 text-grey-darker font-light leading-normal">
        <div class="flex-col">
          <div class="max-w-full">
            

          </div>

          <div class="post max-w-full md:max-w-md">
            
            

            <div>
              <a class="no-underline uppercase text-sm" href="/til"> ← til </a>
            </div>

            <div class="mb-8">
              <h1>Refactoring a large case statement</h1>
              
              <div class="text-grey">
                February 3, 2019
              </div>
              

              <div class="flex my-2">
                
                  <span class="bg-grey-lightest py-1 px-2 text-center text-grey-dark mr-2 rounded text-sm">
                    ruby
                  </span>
                
              </div>
            </div>

            <p>I&#39;m currently building a gem for converting
curl commands to something else, and one early
problem I needed to deal with was parsing the 
curl command arguments.</p>

<p>The basic idea for a gem is to convert curl command to
a sweet looking hash that we can use to do
magical things. So when given:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>curl https://isrubydead.com/
</code></pre></div>
<p>Our program converts it to:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="p">{</span>
  <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
  <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
  <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="p">{},</span>
  <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;https://isrubydead.com/&quot;</span>
<span class="p">}</span>
</code></pre></div>
<p>We&#39;ll call this hash a <code>Request</code>, so let&#39;s define it:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="no">Request</span> <span class="o">=</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:body</span><span class="p">,</span> <span class="ss">:method</span><span class="p">,</span> <span class="ss">:headers</span><span class="p">,</span> <span class="ss">:url</span><span class="p">)</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;GET&#39;</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Our program should expect the curl command as a command line
argument, so let&#39;s use <code>ARGV.first</code> to read the curl
command:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="nb">require</span> <span class="s1">&#39;shellwords&#39;</span>

<span class="k">module</span> <span class="nn">ParseCurl</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="no">Request</span><span class="o">.</span><span class="n">new</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="no">Parser</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

      <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="no">Shellwords</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">strip</span><span class="p">))</span>

      <span class="n">request</span><span class="o">.</span><span class="n">to_h</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="kp">attr_accessor</span> <span class="ss">:request</span>
    <span class="kp">attr_accessor</span> <span class="ss">:parser</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">ParseCurl</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="no">ARGV</span><span class="o">.</span><span class="n">first</span><span class="p">)</span>
</code></pre></div>
<p>We use <code>Shellwords</code> here to convert the curl command
to an array of tokens, to make it easier to parse.</p>

<p>Now that we have a place to store the result of parsing 
the curl command, and we are passing the command line
argument to a parser, it&#39;s time to write an actual parser.</p>

<p>Being a very serious and very senior developer,
I&#39;ve ended up with this very appealing class:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">class</span> <span class="nc">Parser</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="vi">@request</span> <span class="o">=</span> <span class="n">request</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">words</span> <span class="o">=</span> <span class="n">words</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">word</span> <span class="o">=</span> <span class="n">words</span><span class="o">.</span><span class="n">shift</span><span class="p">)</span>
      <span class="n">parse_word</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="kp">attr_accessor</span> <span class="ss">:words</span>
  <span class="kp">attr_reader</span> <span class="ss">:request</span>

  <span class="k">def</span> <span class="nf">parse_word</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">word</span>
    <span class="k">when</span> <span class="no">URI</span><span class="o">::</span><span class="no">DEFAULT_PARSER</span><span class="o">.</span><span class="n">make_regexp</span>
      <span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">word</span>
    <span class="k">when</span> <span class="sr">/\A(-H|--header)\Z/</span>
      <span class="n">parse_header</span>
    <span class="k">when</span> <span class="sr">/\A--compressed\Z/</span>
      <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s1">&#39;Accept-Encoding&#39;</span><span class="o">]</span> <span class="o">||=</span> <span class="s1">&#39;deflate, gzip&#39;</span>
    <span class="k">when</span> <span class="sr">/\A-X|\A--request\Z/</span>
      <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">extract_method</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="k">when</span> <span class="sr">/\A(-u|--user)\Z/</span>
      <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s1">&#39;Authorization&#39;</span><span class="o">]</span> <span class="o">||=</span>
        <span class="s2">&quot;Basic </span><span class="si">#{</span><span class="no">Base64</span><span class="o">.</span><span class="n">strict_encode64</span><span class="p">(</span><span class="n">words</span><span class="o">.</span><span class="n">shift</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">when</span> <span class="sr">/\A(-b|--cookie)\Z/</span>
      <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s1">&#39;Set-Cookie&#39;</span><span class="o">]</span> <span class="o">||=</span> <span class="n">words</span><span class="o">.</span><span class="n">shift</span>
    <span class="k">when</span> <span class="sr">/\A(-A|--user-agent)\Z/</span>
      <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s1">&#39;User-Agent&#39;</span><span class="o">]</span> <span class="o">||=</span> <span class="n">words</span><span class="o">.</span><span class="n">shift</span>
    <span class="k">when</span> <span class="sr">/\A(-I|--head)\Z/</span>
      <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;HEAD&#39;</span>
    <span class="k">when</span> <span class="sr">/\A(-d|--data|--data-ascii)\Z/</span>
      <span class="n">parse_data</span>
    <span class="k">when</span> <span class="sr">/\A--data-binary\Z/</span>
      <span class="n">parse_data</span><span class="p">(</span><span class="ss">strip_newlines</span><span class="p">:</span> <span class="kp">false</span><span class="p">)</span>
    <span class="k">when</span> <span class="sr">/\A--data-raw\Z/</span>
      <span class="n">parse_data</span><span class="p">(</span><span class="ss">raw</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
    <span class="k">when</span> <span class="sr">/\A--data-urlencode\Z/</span>
      <span class="n">parse_data</span><span class="p">(</span><span class="ss">url_encode</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
    <span class="k">when</span> <span class="sr">/\./</span>
      <span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">word</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>I know, a thing a beauty.</p>

<p>What&#39;s also very nice is that this class
also have to know everything about parsing curl arguments;
from header and method arguments to various data arguments.</p>

<p>Super nice! Just look at these beautiful methods, that
all belong to this class:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">class</span> <span class="nc">Parser</span>
  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">parse_data</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;POST&#39;</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span> <span class="o">||</span>
                               <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;HEAD&#39;</span>
    <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">]</span> <span class="o">||=</span>
      <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">extract_data</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">request</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">empty?</span>
                     <span class="n">data</span>
                   <span class="k">else</span>
                     <span class="s2">&quot;</span><span class="si">#{</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="s2">&amp;</span><span class="si">#{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span>
                   <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">parse_header</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">extract_header</span><span class="p">(</span><span class="n">words</span><span class="o">.</span><span class="n">shift</span><span class="p">)</span>

    <span class="k">return</span> <span class="k">unless</span> <span class="n">header</span>

    <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">first</span><span class="o">]</span> <span class="o">=</span>
      <span class="n">header</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">first</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">extract_data</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">words</span><span class="o">.</span><span class="n">shift</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="n">data</span> <span class="o">=~</span> <span class="sr">/\A@/</span> <span class="o">||</span> <span class="n">args</span><span class="o">[</span><span class="ss">:raw</span><span class="o">]</span>
    <span class="n">data</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span><span class="n">word</span><span class="p">,</span>
                <span class="ss">strip_newlines</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
                <span class="ss">raw</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span>
                <span class="ss">url_encode</span><span class="p">:</span> <span class="kp">false</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">raw</span> <span class="p">?</span> <span class="n">word</span> <span class="p">:</span> <span class="n">word</span><span class="o">[</span><span class="mi">1</span><span class="o">..-</span><span class="mi">1</span><span class="o">]</span>
    <span class="n">content</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">content</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="sr">/\n|\r/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">strip_newlines</span>
    <span class="n">content</span> <span class="o">=</span> <span class="no">CGI</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="k">if</span> <span class="n">url_encode</span>
    <span class="n">content</span>
  <span class="k">rescue</span> <span class="no">Errno</span><span class="o">::</span><span class="no">ENOENT</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="n">data</span><span class="o">[</span><span class="mi">1</span><span class="o">..-</span><span class="mi">1</span><span class="o">]</span><span class="p">)</span>
    <span class="k">raise</span> <span class="no">FileNotFoundError</span><span class="p">,</span>
      <span class="s2">&quot;Cannot read file: </span><span class="si">#{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">. Does it exist?&quot;</span>
  <span class="k">end</span>

  <span class="c1"># Needed for extracting -XPUT and similar formats.</span>
  <span class="k">def</span> <span class="nf">extract_method</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">words</span><span class="o">.</span><span class="n">shift</span> <span class="k">unless</span> <span class="n">word</span> <span class="o">=~</span> <span class="sr">/^-X/</span>

    <span class="k">if</span> <span class="o">!</span><span class="p">(</span><span class="nb">method</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^-X(.*)/</span><span class="p">)</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">empty?</span>
      <span class="nb">method</span>
    <span class="k">else</span>
      <span class="n">words</span><span class="o">.</span><span class="n">shift</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">extract_header</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
    <span class="o">[</span><span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sr">/: (.+)/</span><span class="p">)</span><span class="o">].</span><span class="n">to_h</span>
  <span class="k">rescue</span> <span class="no">StandardError</span>
    <span class="kp">nil</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Marvelous! This class knows absolutely everything
about curl and all the arguments and options.
We could ask it the curl&#39;s shoe size, 
and it would give us the answer.</p>

<p>Now that we have thought this class so much, and it
has achieved the master&#39;s degree worth of education
in the University of curl, I&#39;m a little worried it&#39;s going to take over the world.</p>

<p>Sure, it only knows about curl for now, but what happens
when someone decides it should know about, I don&#39;t know,
some scary AI thing. It looks innocent right now,
but then you turn around and it <a href="https://www.youtube.com/watch?v=aFuA50H9uek">gets interested in doors</a>. </p>

<p>I don&#39;t trust it one bit, so let&#39;s steal some knowledge
from this class and let&#39;s spread it to other classes.</p>

<p><em>I&#39;ll now start explaining the refactoring step by step,
but you can take a look at <a href="#final">the final result</a> if you&#39;d like to
skip.</em></p>

<p>This class will from now on be ignorant of curl arguments, so the humongous case statement becomes:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">class</span> <span class="nc">Parser</span>
  <span class="k">def</span> <span class="nf">parse_word</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="no">Word</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Since every scenario we have to cover in the case statement consists
of the regex check and the parsing part, the idea is to abstract those into 
class.</p>

<p>Let&#39;s introduce the <code>Word::Base</code> class:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">module</span> <span class="nn">Word</span>
  <span class="k">class</span> <span class="nc">Base</span>
    <span class="c1"># Used to check if the word given matches the subclass&#39; regex.</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">===</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
      <span class="n">word</span> <span class="o">=~</span> <span class="n">regex</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="k">raise</span> <span class="no">NotImplementedError</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2"> doesn&#39;t have .regex defined&quot;</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="k">raise</span> <span class="no">NotImplementedError</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> doesn&#39;t have #parse defined&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>The plan is to have one base class, that will be inherited for every
scenario we&#39;d like to cover. Here&#39;s the first example of one such class:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">module</span> <span class="nn">Word</span>
  <span class="k">class</span> <span class="nc">Header</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A(-H|--header)\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">header</span> <span class="o">=</span> <span class="n">extract_header</span><span class="p">(</span><span class="n">words</span><span class="o">.</span><span class="n">shift</span><span class="p">)</span>

      <span class="k">return</span> <span class="k">unless</span> <span class="n">header</span>

      <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">first</span><span class="o">]</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">first</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">extract_header</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
      <span class="o">[</span><span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sr">/: (.+)/</span><span class="p">)</span><span class="o">].</span><span class="n">to_h</span>
    <span class="k">rescue</span> <span class="no">StandardError</span>
      <span class="kp">nil</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>This class stores information about everything that&#39;s needed to
parse a header argument. It detects the argument (when the curl command includes
<code>-H</code> or <code>--header</code> in arguments) and then changes the request hash,
which we return in the end.</p>

<p>Since this class has to know about <code>words</code> and <code>request</code>
too, we&#39;ll add that to the base class. We expect other descendants
to need that too:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">module</span> <span class="nn">Word</span>
  <span class="k">class</span> <span class="nc">Base</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
      <span class="vi">@words</span> <span class="o">=</span> <span class="n">words</span>
      <span class="vi">@request</span> <span class="o">=</span> <span class="n">request</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="kp">attr_reader</span> <span class="ss">:words</span>
    <span class="kp">attr_reader</span> <span class="ss">:request</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>The next problem we have is that there&#39;s no connection between
the original <code>parse_word</code> method and this new class we have created,
so let&#39;s write a method that connects those two:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">module</span> <span class="nn">Word</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>
    <span class="n">subclass</span> <span class="o">=</span> <span class="no">Word</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">subclasses</span>
                         <span class="o">.</span><span class="n">detect</span> <span class="p">{</span> <span class="o">|</span><span class="n">klass</span><span class="o">|</span> <span class="n">klass</span> <span class="o">===</span> <span class="n">word</span> <span class="p">}</span>
    <span class="n">subclass</span><span class="o">&amp;.</span><span class="n">new</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span><span class="o">&amp;.</span><span class="n">parse</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Base</span>
    <span class="c1"># List of subclasses, first-inherited class first.</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">subclasses</span>
      <span class="no">ObjectSpace</span><span class="o">.</span><span class="n">each_object</span><span class="p">(</span><span class="no">Base</span><span class="o">.</span><span class="n">singleton_class</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">reject</span> <span class="p">{</span> <span class="o">|</span><span class="n">klass</span><span class="o">|</span> <span class="n">klass</span> <span class="o">==</span> <span class="no">Base</span> <span class="p">}</span><span class="o">.</span><span class="n">reverse</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>With this method we can find a <code>Word::Base</code> subclass that matches the word
that was given and then parses that word. If we find the subclass,
we try to parse the word. So our current code works
for parsing <code>--header</code> or <code>-h</code> words from curl.</p>

<p>Our code now supports parsing headers, so let&#39;s proceed to add
classes for every argument we&#39;d like to support:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">module</span> <span class="nn">Word</span>
  <span class="k">class</span> <span class="nc">Compressed</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A--compressed\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s1">&#39;Accept-Encoding&#39;</span><span class="o">]</span> <span class="o">||=</span> <span class="s1">&#39;deflate, gzip&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Request</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A-X|\A--request\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
      <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">extract_method</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="c1"># Needed for extracting -XPUT and similar formats.</span>
    <span class="k">def</span> <span class="nf">extract_method</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">words</span><span class="o">.</span><span class="n">shift</span> <span class="k">unless</span> <span class="n">word</span> <span class="o">=~</span> <span class="sr">/^-X/</span>

      <span class="k">if</span> <span class="o">!</span><span class="p">(</span><span class="nb">method</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^-X(.*)/</span><span class="p">)</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">empty?</span>
        <span class="nb">method</span>
      <span class="k">else</span>
        <span class="n">words</span><span class="o">.</span><span class="n">shift</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Authorization</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A(-u|--user)\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s1">&#39;Authorization&#39;</span><span class="o">]</span> <span class="o">||=</span>
        <span class="s2">&quot;Basic </span><span class="si">#{</span><span class="no">Base64</span><span class="o">.</span><span class="n">strict_encode64</span><span class="p">(</span><span class="n">words</span><span class="o">.</span><span class="n">shift</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Cookie</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A(-b|--cookie)\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s1">&#39;Set-Cookie&#39;</span><span class="o">]</span> <span class="o">||=</span> <span class="n">words</span><span class="o">.</span><span class="n">shift</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">UserAgent</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A(-A|--user-agent)\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s1">&#39;User-Agent&#39;</span><span class="o">]</span> <span class="o">||=</span> <span class="n">words</span><span class="o">.</span><span class="n">shift</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Head</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A(-I|--head)\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;HEAD&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Data</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A(-d|--data|--data-ascii)\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">options</span>
      <span class="p">{}</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;POST&#39;</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span> <span class="o">||</span>
                                 <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;HEAD&#39;</span>
      <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">]</span> <span class="o">||=</span>
        <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span>

      <span class="n">data</span> <span class="o">=</span> <span class="n">extract_data</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

      <span class="n">request</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">empty?</span>
                       <span class="n">data</span>
                     <span class="k">else</span>
                       <span class="s2">&quot;</span><span class="si">#{</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="s2">&amp;</span><span class="si">#{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span>
                     <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">extract_data</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
      <span class="n">data</span> <span class="o">=</span> <span class="n">words</span><span class="o">.</span><span class="n">shift</span>
      <span class="n">data</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="n">data</span> <span class="o">=~</span> <span class="sr">/\A@/</span> <span class="o">||</span>
                                      <span class="n">args</span><span class="o">[</span><span class="ss">:raw</span><span class="o">]</span>
      <span class="n">data</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span><span class="n">word</span><span class="p">,</span>
                  <span class="ss">strip_newlines</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
                  <span class="ss">raw</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span>
                  <span class="ss">url_encode</span><span class="p">:</span> <span class="kp">false</span><span class="p">)</span>
      <span class="n">path</span> <span class="o">=</span> <span class="n">raw</span> <span class="p">?</span> <span class="n">word</span> <span class="p">:</span> <span class="n">word</span><span class="o">[</span><span class="mi">1</span><span class="o">..-</span><span class="mi">1</span><span class="o">]</span>
      <span class="n">content</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
      <span class="n">content</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="sr">/\n|\r/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">strip_newlines</span>
      <span class="n">content</span> <span class="o">=</span> <span class="no">CGI</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="k">if</span> <span class="n">url_encode</span>
      <span class="n">content</span>
    <span class="k">rescue</span> <span class="no">Errno</span><span class="o">::</span><span class="no">ENOENT</span>
      <span class="n">file_path</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="n">data</span><span class="o">[</span><span class="mi">1</span><span class="o">..-</span><span class="mi">1</span><span class="o">]</span><span class="p">)</span>
      <span class="k">raise</span> <span class="no">FileNotFoundError</span><span class="p">,</span>
            <span class="s2">&quot;Cannot read file: </span><span class="si">#{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">. Does it exist?&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">StripNewlinesData</span> <span class="o">&lt;</span> <span class="no">Data</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A--data-binary\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">options</span>
      <span class="p">{</span> <span class="ss">strip_newlines</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">RawData</span> <span class="o">&lt;</span> <span class="no">Data</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A--data-raw\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">options</span>
      <span class="p">{</span> <span class="ss">raw</span><span class="p">:</span> <span class="kp">true</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">URLEncodeData</span> <span class="o">&lt;</span> <span class="no">Data</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A--data-urlencode\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">options</span>
      <span class="p">{</span> <span class="ss">url_encode</span><span class="p">:</span> <span class="kp">true</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">URL</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">===</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
      <span class="n">word</span> <span class="o">=~</span> <span class="no">URI</span><span class="o">::</span><span class="no">DEFAULT_PARSER</span><span class="o">.</span><span class="n">make_regexp</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
      <span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">word</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">NonStrictURL</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\./</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
      <span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">word</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>Here&#39;s the <a name="final">final</a> code we end up with:</p>
<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span><span class="k">module</span> <span class="nn">Word</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>
    <span class="n">subclass</span> <span class="o">=</span> <span class="no">Word</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">subclasses</span>
                         <span class="o">.</span><span class="n">detect</span> <span class="p">{</span> <span class="o">|</span><span class="n">klass</span><span class="o">|</span> <span class="n">klass</span> <span class="o">===</span> <span class="n">word</span> <span class="p">}</span>
    <span class="n">subclass</span><span class="o">&amp;.</span><span class="n">new</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span><span class="o">&amp;.</span><span class="n">parse</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Base</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
      <span class="vi">@words</span> <span class="o">=</span> <span class="n">words</span>
      <span class="vi">@request</span> <span class="o">=</span> <span class="n">request</span>
    <span class="k">end</span>

    <span class="c1"># List of subclasses, first-inherited class appears first.</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">subclasses</span>
      <span class="no">ObjectSpace</span><span class="o">.</span><span class="n">each_object</span><span class="p">(</span><span class="no">Base</span><span class="o">.</span><span class="n">singleton_class</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">reject</span> <span class="p">{</span> <span class="o">|</span><span class="n">klass</span><span class="o">|</span> <span class="n">klass</span> <span class="o">==</span> <span class="no">Base</span> <span class="p">}</span><span class="o">.</span><span class="n">reverse</span>
    <span class="k">end</span>

    <span class="c1"># Used to check if the word given matches the subclass&#39; regex.</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">===</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
      <span class="n">word</span> <span class="o">=~</span> <span class="n">regex</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="k">raise</span> <span class="no">NotImplementedError</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2"> doesn&#39;t have .regex defined&quot;</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="k">raise</span> <span class="no">NotImplementedError</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> doesn&#39;t have #parse defined&quot;</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="kp">attr_reader</span> <span class="ss">:words</span>
    <span class="kp">attr_reader</span> <span class="ss">:request</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Header</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A(-H|--header)\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">header</span> <span class="o">=</span> <span class="n">extract_header</span><span class="p">(</span><span class="n">words</span><span class="o">.</span><span class="n">shift</span><span class="p">)</span>

      <span class="k">return</span> <span class="k">unless</span> <span class="n">header</span>

      <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">first</span><span class="o">]</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">first</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">extract_header</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
      <span class="o">[</span><span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sr">/: (.+)/</span><span class="p">)</span><span class="o">].</span><span class="n">to_h</span>
    <span class="k">rescue</span> <span class="no">StandardError</span>
      <span class="kp">nil</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Compressed</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A--compressed\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s1">&#39;Accept-Encoding&#39;</span><span class="o">]</span> <span class="o">||=</span> <span class="s1">&#39;deflate, gzip&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Request</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A-X|\A--request\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
      <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">extract_method</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="c1"># Needed for extracting -XPUT and similar formats.</span>
    <span class="k">def</span> <span class="nf">extract_method</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">words</span><span class="o">.</span><span class="n">shift</span> <span class="k">unless</span> <span class="n">word</span> <span class="o">=~</span> <span class="sr">/^-X/</span>

      <span class="k">if</span> <span class="o">!</span><span class="p">(</span><span class="nb">method</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^-X(.*)/</span><span class="p">)</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">empty?</span>
        <span class="nb">method</span>
      <span class="k">else</span>
        <span class="n">words</span><span class="o">.</span><span class="n">shift</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Authorization</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A(-u|--user)\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s1">&#39;Authorization&#39;</span><span class="o">]</span> <span class="o">||=</span>
        <span class="s2">&quot;Basic </span><span class="si">#{</span><span class="no">Base64</span><span class="o">.</span><span class="n">strict_encode64</span><span class="p">(</span><span class="n">words</span><span class="o">.</span><span class="n">shift</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Cookie</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A(-b|--cookie)\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s1">&#39;Set-Cookie&#39;</span><span class="o">]</span> <span class="o">||=</span> <span class="n">words</span><span class="o">.</span><span class="n">shift</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">UserAgent</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A(-A|--user-agent)\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s1">&#39;User-Agent&#39;</span><span class="o">]</span> <span class="o">||=</span> <span class="n">words</span><span class="o">.</span><span class="n">shift</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Head</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A(-I|--head)\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;HEAD&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Data</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A(-d|--data|--data-ascii)\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">options</span>
      <span class="p">{}</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
      <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;POST&#39;</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span> <span class="o">||</span>
                                 <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;HEAD&#39;</span>
      <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">]</span> <span class="o">||=</span>
        <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span>

      <span class="n">data</span> <span class="o">=</span> <span class="n">extract_data</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

      <span class="n">request</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">empty?</span>
                       <span class="n">data</span>
                     <span class="k">else</span>
                       <span class="s2">&quot;</span><span class="si">#{</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="si">}</span><span class="s2">&amp;</span><span class="si">#{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span>
                     <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">extract_data</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
      <span class="n">data</span> <span class="o">=</span> <span class="n">words</span><span class="o">.</span><span class="n">shift</span>
      <span class="n">data</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="n">data</span> <span class="o">=~</span> <span class="sr">/\A@/</span> <span class="o">||</span>
                                      <span class="n">args</span><span class="o">[</span><span class="ss">:raw</span><span class="o">]</span>
      <span class="n">data</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span><span class="n">word</span><span class="p">,</span>
                  <span class="ss">strip_newlines</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
                  <span class="ss">raw</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span>
                  <span class="ss">url_encode</span><span class="p">:</span> <span class="kp">false</span><span class="p">)</span>
      <span class="n">path</span> <span class="o">=</span> <span class="n">raw</span> <span class="p">?</span> <span class="n">word</span> <span class="p">:</span> <span class="n">word</span><span class="o">[</span><span class="mi">1</span><span class="o">..-</span><span class="mi">1</span><span class="o">]</span>
      <span class="n">content</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
      <span class="n">content</span><span class="o">.</span><span class="n">gsub!</span><span class="p">(</span><span class="sr">/\n|\r/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">strip_newlines</span>
      <span class="n">content</span> <span class="o">=</span> <span class="no">CGI</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="k">if</span> <span class="n">url_encode</span>
      <span class="n">content</span>
    <span class="k">rescue</span> <span class="no">Errno</span><span class="o">::</span><span class="no">ENOENT</span>
      <span class="n">file_path</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="n">data</span><span class="o">[</span><span class="mi">1</span><span class="o">..-</span><span class="mi">1</span><span class="o">]</span><span class="p">)</span>
      <span class="k">raise</span> <span class="no">FileNotFoundError</span><span class="p">,</span>
            <span class="s2">&quot;Cannot read file: </span><span class="si">#{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">. Does it exist?&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">StripNewlinesData</span> <span class="o">&lt;</span> <span class="no">Data</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A--data-binary\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">options</span>
      <span class="p">{</span> <span class="ss">strip_newlines</span><span class="p">:</span> <span class="kp">false</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">RawData</span> <span class="o">&lt;</span> <span class="no">Data</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A--data-raw\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">options</span>
      <span class="p">{</span> <span class="ss">raw</span><span class="p">:</span> <span class="kp">true</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">URLEncodeData</span> <span class="o">&lt;</span> <span class="no">Data</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\A--data-urlencode\Z/</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">options</span>
      <span class="p">{</span> <span class="ss">url_encode</span><span class="p">:</span> <span class="kp">true</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">URL</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">===</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
      <span class="n">word</span> <span class="o">=~</span> <span class="no">URI</span><span class="o">::</span><span class="no">DEFAULT_PARSER</span><span class="o">.</span><span class="n">make_regexp</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
      <span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">word</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">NonStrictURL</span> <span class="o">&lt;</span> <span class="no">Base</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">regex</span>
      <span class="sr">/\./</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
      <span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="n">word</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Parser</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="vi">@request</span> <span class="o">=</span> <span class="n">request</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">words</span> <span class="o">=</span> <span class="n">words</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">word</span> <span class="o">=</span> <span class="n">words</span><span class="o">.</span><span class="n">shift</span><span class="p">)</span>
      <span class="n">parse_word</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="kp">attr_accessor</span> <span class="ss">:words</span>
  <span class="kp">attr_reader</span> <span class="ss">:request</span>

  <span class="k">def</span> <span class="nf">parse_word</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="no">Word</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">words</span><span class="p">,</span> <span class="n">word</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">ParseCurl</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="no">Request</span><span class="o">.</span><span class="n">new</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="no">Parser</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

      <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="no">Shellwords</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">strip</span><span class="p">))</span>

      <span class="n">request</span><span class="o">.</span><span class="n">to_h</span>
    <span class="k">end</span>

    <span class="kp">private</span>

    <span class="kp">attr_accessor</span> <span class="ss">:request</span>
    <span class="kp">attr_accessor</span> <span class="ss">:parser</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">ParseCurl</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="no">ARGV</span><span class="o">.</span><span class="n">first</span><span class="p">)</span>
</code></pre></div>
<p>Note how each class contains knowledge specific to the 
argument we&#39;re trying to cover with it and nothing else. I
think that&#39;s an improvement since it&#39;s still easy to 
support new arguments, and we don&#39;t pollute a single class
with many methods.</p>



            
          </div>
        </div>
      </div>
    </div>
  </body>

  <script>
  var menu = document.querySelectorAll('[data-hamburger-menu]')[0]
  var openMenu = document.querySelectorAll('[data-open-hamburger-menu]')[0]
  var closeMenu = document.querySelectorAll('[data-close-hamburger-menu]')[0]
  var body = document.body

  openMenu.onclick = toggleMenu.bind(this, true);
  closeMenu.onclick = toggleMenu.bind(this, false);

  function toggleMenu(show) {
    toggleElements([openMenu], !show);
    toggleElements([menu, closeMenu], show);
    toggleScrolling(body, show);
  }

  function toggleElements(elements, show) {
    elements.forEach(function(element) {
      if (show) {
        element.classList.remove("hidden")
        element.classList.add("block");
      } else {
        element.classList.remove("block")
        element.classList.add("hidden");
      }
    })
  }

  function toggleScrolling(element, scrollDisabled) {
    var classes = ["scrolling-auto", "overflow-hidden", "fixed", "pin-x"];
    if (scrollDisabled) {
      classes.forEach(function(klass){
        element.classList.add(klass);
      })
    } else {
      classes.forEach(function(klass){
        element.classList.remove(klass);
      })
    }
  }

  var anchors = new AnchorJS();
  anchors.options = {
    placement: 'left'
  }
  anchors.add()
</script>

</html>
